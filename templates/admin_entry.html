<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>観光データ管理</title>
    <style>
        body {font-family: 'Segoe UI', 'メイリオ', sans-serif; background: #f6faf9;}
        .container {background:#fff; padding:30px 32px; margin:40px auto; max-width:980px; border-radius:17px; box-shadow: 0 4px 20px #b7d3e04d;}
        label {display:inline-block; min-width:70px; font-weight: 500;}
        input[type=text], textarea, select {margin-bottom:12px; width:98%; padding: 6px 10px; font-size:1em; border-radius:7px; border: 1px solid #b0c4d7; background:#fff;}
        textarea {resize:vertical;}
        .entry-card {background:#f7faf7; margin:12px 0; border-radius:12px; padding:14px 16px; box-shadow: 0 2px 6px #e0e6ed30;}
        .entry-actions {margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
        .card-label {color:#2a8ed8; font-size:0.98em;}
        .nav {margin-bottom:20px;}
        .nav a {margin-right:16px; font-size:1em; color:#2a8ed8; text-decoration:none; font-weight:500;}
        .nav a:hover {text-decoration: underline;}
        .add-btn {padding: 7px 24px; font-size:1em; border-radius:7px; background: #2a8ed8; color:#fff; border:none; margin-top: 8px;}
        .del-btn {background: #fff; color: #d76; border: 1px solid #eaa; border-radius: 7px; padding:7px 18px;}
        .del-btn:hover {background:#fee;}
        .row {margin-bottom:10px;}
        .extra-row {margin:6px 0;}
        .mini-note {font-size:0.92em; color:#888;}
        hr {border: 1px solid #e7eef5;}

        /* --- フィルター & ページネーション UI --- */
        .filterbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
        .filterbar input[type=text], .filterbar select{width:auto;min-width:160px}
        .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#2a8ed8;font-size:.9em}
        .btn{padding:7px 14px;border:none;border-radius:8px;background:#2a8ed8;color:#fff;cursor:pointer}
        .btn.ghost{background:#fff;color:#2a8ed8;border:1px solid #b7d3e0}
        .pager{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 10px}
        .pager .btn{padding:6px 10px}
        .pager .info{color:#456;font-size:.92em}
        ul.compact {margin:4px 0 10px 18px; padding:0;}
        ul.compact li {margin:2px 0;}
        table.kv {border-collapse: collapse; margin:4px 0 8px 0;}
        table.kv td {border:1px solid #e3e9ee; padding:4px 6px; font-size:0.92em}
        table.kv td.k {background:#f6f9fb; min-width:120px; font-weight:500; color:#345;}
        .muted{color:#789;font-size:.92em}

        @media (max-width: 700px) {
            .container {padding:10px;}
            input[type=text], textarea {width:96%;}
            .filterbar input[type=text], .filterbar select {min-width:130px}
        }
    </style>
    <script>
    function onCategoryChange() {
        var cat = document.getElementById('category_select').value;
        document.getElementById('form_tourism').style.display = (cat === '観光') ? 'block' : 'none';
        document.getElementById('form_shop').style.display = (cat !== '観光') ? 'block' : 'none';
    }
    function addExtraRow(targetId) {
        const wrap = document.getElementById(targetId);
        const div = document.createElement('div');
        div.className = 'extra-row';
        div.innerHTML = `
          <input name="extras_key[]" placeholder="項目">
          ＝
          <input name="extras_val[]" placeholder="内容">
          <button type="button" onclick="this.parentNode.remove()">－</button>
        `;
        wrap.appendChild(div);
    }
    function validateAreas(formId) {
        const form = document.getElementById(formId);
        const checks = form.querySelectorAll('input[name="areas"]:checked');
        if (checks.length === 0) {
            alert('エリアは1つ以上選択してください。');
            return false;
        }
        return true;
    }

    // ====== フィルタ & ソート & ページネーション ======
    let PAGING = {page:1, size:20, totalFiltered:0, totalAll:0};

    function _norm(s){ return (s||'').toString().toLowerCase(); }

    function filterCards(resetPage=true){
      const q = _norm(document.getElementById('f_q').value);
      const cat = document.getElementById('f_cat').value;
      const area = document.getElementById('f_area').value;
      const tagsRaw = document.getElementById('f_tag').value.trim();
      const sort = document.getElementById('f_sort').value;
      const requireTags = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean).map(_norm) : [];

      const list = Array.from(document.querySelectorAll('.entry-card'));
      let filtered = [];

      // 絞り込み
      list.forEach(card=>{
        const txt = card.dataset.text;      // title/desc/address/tags/links/extras
        const dcat = card.dataset.category; // カテゴリ
        const dtags = (card.dataset.tags||'').split(',').map(_norm);
        const dareas = (card.dataset.areas||'').split(',').map(s=>s.trim());
        let ok = true;

        if(q && !txt.includes(q)) ok = false;
        if(cat && dcat !== cat) ok = false;
        if(area && !dareas.includes(area)) ok = false;
        if(requireTags.length){
          for(const t of requireTags){
            if(!dtags.includes(t)){ ok = false; break; }
          }
        }
        // いったん全て非表示、OKなものは配列へ（表示制御は後段のページネーションで）
        card.style.display = 'none';
        if(ok) filtered.push(card);
      });

      // 並び替え（フィルタ適用後）
      filtered.sort((a,b)=>{
        if(sort==='title_asc')  return a.dataset.title.localeCompare(b.dataset.title, 'ja');
        if(sort==='title_desc') return b.dataset.title.localeCompare(a.dataset.title, 'ja');
        if(sort==='cat_asc'){
          const c = a.dataset.category.localeCompare(b.dataset.category, 'ja'); 
          if(c!==0) return c;
          return a.dataset.title.localeCompare(b.dataset.title, 'ja');
        }
        if(sort==='cat_desc'){
          const c = b.dataset.category.localeCompare(a.dataset.category, 'ja'); 
          if(c!==0) return c;
          return a.dataset.title.localeCompare(b.dataset.title, 'ja');
        }
        return 0;
      });

      // 件数更新
      PAGING.totalFiltered = filtered.length;
      PAGING.totalAll = list.length;

      if(resetPage) PAGING.page = 1;

      // ページネーション適用
      applyPagination(filtered);
    }

    function applyPagination(filtered){
      const size = PAGING.size;
      const totalPages = Math.max(1, Math.ceil((filtered.length || 0) / size));
      if(PAGING.page > totalPages) PAGING.page = totalPages;
      if(PAGING.page < 1) PAGING.page = 1;
      const start = (PAGING.page - 1) * size;
      const end = Math.min(start + size, filtered.length);

      // 表示制御
      for(let i=0;i<filtered.length;i++){
        filtered[i].style.display = (i>=start && i<end) ? '' : 'none';
      }

      // カウンタ/ページ情報
      document.getElementById('f_count').textContent = PAGING.totalFiltered;
      document.getElementById('f_total').textContent = PAGING.totalAll;
      const info = `ページ ${PAGING.page} / ${totalPages}（1ページ ${size}件）`;
      document.querySelectorAll('.pager .info').forEach(el=>el.textContent = info);

      // ページャーボタンの活性/非活性
      document.querySelectorAll('.pager').forEach(pg=>{
        pg.querySelector('.prev').disabled = (PAGING.page<=1);
        pg.querySelector('.next').disabled = (PAGING.page>=totalPages);
        pg.querySelector('.first').disabled = (PAGING.page<=1);
        pg.querySelector('.last').disabled = (PAGING.page>=totalPages);
      });
    }

    function resetFilters(){
      document.getElementById('f_q').value='';
      document.getElementById('f_cat').value='';
      document.getElementById('f_area').value='';
      document.getElementById('f_tag').value='';
      document.getElementById('f_sort').value='title_asc';
      PAGING.page = 1;
      filterCards(false);
    }

    function onChangePageSize(sel){
      PAGING.size = parseInt(sel.value || '20', 10);
      PAGING.page = 1;
      filterCards(false);
    }

    function gotoPage(which){
      if(which==='first') PAGING.page = 1;
      else if(which==='prev') PAGING.page -= 1;
      else if(which==='next') PAGING.page += 1;
      else if(which==='last'){
        const size = PAGING.size;
        const totalPages = Math.max(1, Math.ceil(PAGING.totalFiltered / size));
        PAGING.page = totalPages;
      }
      filterCards(false);
    }

    window.onload = function(){ onCategoryChange(); filterCards(); };
    </script>
</head>
<body>
<div class="container">

    {# --- セーフティ: 渡し忘れ/古いデータ形式でも落ちないように --- #}
    {% if cat_list is not defined %}
      {% set cat_list = ["観光","飲食","宿泊","診療所","役所","交通","バス","イベント","特売"] %}
    {% endif %}
    {% if area_opts is not defined %}
      {% set area_opts = ["五島市","新上五島町","宇久町","小値賀町"] %}
    {% endif %}
    {% if entries is not defined %}
      {% set entries = [] %}
    {% endif %}

    {% if role == "admin" %}
    <div class="nav" style="float:right;">
        <a href="{{ url_for('admin_logs') }}">[質問・回答ログ一覧]</a>
        <a href="{{ url_for('admin_unhit_questions') }}">[未ヒット質問一覧]</a>
        <a href="{{ url_for('admin_unhit_report') }}">[未ヒット頻出レポート]</a>
        <a href="{{ url_for('admin_synonyms') }}">[類義語辞書管理]</a>
        <a href="{{ url_for('admin_backup') }}">[全体バックアップ]</a>
        <a href="{{ url_for('admin_entries_edit') }}">[観光データ一括編集]</a>
        <a href="{{ safe_url_for('admin_data_files') }}">[テキストデータ管理（.txt）]</a>
        <a href="{{ url_for('admin_notices') }}">[お知らせ管理]</a>
        <a href="{{ url_for('notices') }}">[お知らせ一覧]</a>
        <a href="{{ url_for('admin_manual') }}" style="margin-right:14px;">[運用マニュアル]</a>
        <form action="{{ url_for('admin_restore') }}" method="post" enctype="multipart/form-data" style="display:inline;">
            <input type="file" name="backup_zip" accept=".zip" style="display:inline;">
            <button type="submit" onclick="return confirm('現在のデータが上書きされます。本当に復元しますか？');">[全体復元]</button>
        </form>
        <form method="post" action="{{ url_for('admin_line_pause') }}" style="display:inline;">
          <button class="btn" type="submit" style="background:#e35;"
                  onclick="return confirm('LINE応答を一時停止します。よろしいですか？');">
            [LINE応答 一時停止]
          </button>
        </form>
        <form method="post" action="{{ url_for('admin_line_resume') }}" style="display:inline;">
          <button class="btn ghost" type="submit">[再開]</button>
        </form>
        {% if global_paused %}
          <span class="badge" style="background:#fee;color:#c33;margin-left:8px;">LINE停止中</span>
        {% endif %}
    </div>
    <h1 style="margin-bottom:20px;">観光データ（管理者モード） {{ '編集' if edit_id else '登録' }}</h1>
    {% else %}
    <h1 style="margin-bottom:20px;">観光データ（店舗ユーザーモード） {{ '編集' if edit_id else '登録' }}</h1>
    {% endif %}

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
        {% for message in messages %}
          <li style="color:green; font-weight:500;">{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {# entry_edit 用の安全な下準備 #}
    {% set _areas_edit = (entry_edit.areas if entry_edit and entry_edit.areas is defined and entry_edit.areas is not string
                          else (entry_edit.areas.split(',') if entry_edit and entry_edit.areas else [])) %}

    <!-- ===== 登録フォーム ===== -->
    <form method="post" id="entry_form" style="margin-bottom:28px;" onsubmit="return validateAreas('entry_form')">
        {% if edit_id %}
        <input type="hidden" name="edit_id" value="{{ edit_id }}">
        {% endif %}

        <label>カテゴリー</label><br>
        <select name="category" id="category_select" onchange="onCategoryChange()">
            {% for c in cat_list %}
            <option value="{{ c }}" {% if entry_edit and entry_edit.category == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
        <hr>

        <!-- 観光地用フォーム -->
        <div id="form_tourism" style="display:none;">
            <label>タイトル</label><br>
            <input type="text" name="title" value="{{ entry_edit.title if entry_edit else '' }}" required><br>
            <label>説明</label><br>
            <textarea name="desc" rows="3" required>{{ entry_edit.desc if entry_edit else '' }}</textarea><br>
            <label>住所</label><br>
            <input type="text" name="address" value="{{ entry_edit.address if entry_edit else '' }}"><br>
            <label>地図URL</label><br>
            <input type="text" name="map" value="{{ entry_edit.map if entry_edit else '' }}"><br>
            <label>タグ <span class="mini-note">（カンマ区切りで複数OK）</span></label><br>
            <input type="text" name="tags" value="{% if entry_edit and entry_edit.tags %}{{ (entry_edit.tags|join(',')) if entry_edit.tags is not string else entry_edit.tags }}{% endif %}"><br>
            <label>エリア（市町）<span style="color:red; font-size:0.96em;">※1つ以上必須</span></label><br>
            <div class="row">
            {% for area in area_opts %}
              <label style="min-width:unset;">
              <input type="checkbox" name="areas" value="{{ area }}"
              {% if _areas_edit and area in _areas_edit %}checked{% endif %}>
              {{ area }}
              </label>
            {% endfor %}
            </div>
            <!-- ▼ 追加: リンク（複数） -->
            <label>リンク（複数可）<span class="mini-note">（1行1URL／カンマ区切りも可）</span></label><br>
            <textarea name="links" rows="3" placeholder="https://example.com
https://instagram.com/xxx">
{% if entry_edit and entry_edit.links %}
{{ (entry_edit.links|join('\n')) if entry_edit.links is not string else entry_edit.links }}
{% endif %}</textarea><br>

            <!-- ▼ 追加: 追加情報（項目＝内容） -->
            <label>追加情報（項目＝内容）</label>
            <div id="extras-list-tourism">
              {% set _extras = (entry_edit.extras if entry_edit and entry_edit.extras else {}) %}
              {% if _extras.items is defined %}
                {% for k, v in _extras.items() %}
                  <div class="extra-row">
                    <input name="extras_key[]" value="{{ k }}" placeholder="項目"> ＝
                    <input name="extras_val[]" value="{{ v }}" placeholder="内容">
                    <button type="button" onclick="this.parentNode.remove()">－</button>
                  </div>
                {% endfor %}
              {% else %}
                <div class="extra-row">
                  <input name="extras_key[]" placeholder="項目"> ＝
                  <input name="extras_val[]" placeholder="内容">
                  <button type="button" onclick="this.parentNode.remove()">－</button>
                </div>
              {% endif %}
            </div>
            <button type="button" class="add-btn" style="background:#5aa;" onclick="addExtraRow('extras-list-tourism')">＋ 行を追加</button>
        </div>

        <!-- 店舗系カテゴリ用フォーム -->
        <div id="form_shop" style="display:none;">
            <label>タイトル</label><br>
            <input type="text" name="title" value="{{ entry_edit.title if entry_edit else '' }}" required><br>
            <label>説明</label><br>
            <textarea name="desc" rows="3" required>{{ entry_edit.desc if entry_edit else '' }}</textarea><br>
            <label>住所</label><br>
            <input type="text" name="address" value="{{ entry_edit.address if entry_edit else '' }}"><br>
            <label>電話番号</label><br>
            <input type="text" name="tel" value="{{ entry_edit.tel if entry_edit else '' }}"><br>
            <label>休み</label><br>
            <input type="text" name="holiday" value="{{ entry_edit.holiday if entry_edit else '' }}"><br>
            <label>営業時間</label><br>
            <input type="text" name="open_hours" value="{{ entry_edit.open_hours if entry_edit else '' }}"><br>
            <label>駐車場</label>
            <select name="parking">
                <option value="あり" {% if entry_edit and entry_edit.parking == 'あり' %}selected{% endif %}>あり</option>
                <option value="なし" {% if entry_edit and entry_edit.parking == 'なし' %}selected{% endif %}>なし</option>
            </select>
            台数：<input type="text" name="parking_num" value="{{ entry_edit.parking_num if entry_edit else '' }}" style="width:80px;">台<br>
            <label>支払方法</label><br>
            {% set _pay_edit = (entry_edit.payment if entry_edit and entry_edit.payment is defined and entry_edit.payment is not string
                                 else (entry_edit.payment.split(',') if entry_edit and entry_edit.payment else [])) %}
            <input type="checkbox" name="payment" value="現金" {% if '現金' in _pay_edit %}checked{% endif %}>現金
            <input type="checkbox" name="payment" value="カード" {% if 'カード' in _pay_edit %}checked{% endif %}>カード
            <input type="checkbox" name="payment" value="その他" {% if 'その他' in _pay_edit %}checked{% endif %}>その他<br>
            <label>備考（自由記述）</label><br>
            <textarea name="remark" rows="2">{{ entry_edit.remark if entry_edit else '' }}</textarea><br>
            <label>タグ <span class="mini-note">（カンマ区切りで複数OK）</span></label><br>
            <input type="text" name="tags" value="{% if entry_edit and entry_edit.tags %}{{ (entry_edit.tags|join(',')) if entry_edit.tags is not string else entry_edit.tags }}{% endif %}"><br>
            <label>エリア（市町）<span style="color:red; font-size:0.96em;">※1つ以上必須</span></label><br>
            <div class="row">
            {% for area in area_opts %}
              <label style="min-width:unset;">
                <input type="checkbox" name="areas" value="{{ area }}"
                {% if _areas_edit and area in _areas_edit %}checked{% endif %}>
                {{ area }}
              </label>
            {% endfor %}
            </div>
            <label>地図URL</label><br>
            <input type="text" name="map" value="{{ entry_edit.map if entry_edit else '' }}"><br>

            <!-- ▼ 追加: リンク（複数） -->
            <label>リンク（複数可）<span class="mini-note">（1行1URL／カンマ区切りも可）</span></label><br>
            <textarea name="links" rows="3" placeholder="https://example.com
https://instagram.com/xxx">
{% if entry_edit and entry_edit.links %}
{{ (entry_edit.links|join('\n')) if entry_edit.links is not string else entry_edit.links }}
{% endif %}</textarea><br>

            <!-- ▼ 追加: 追加情報（項目＝内容） -->
            <label>追加情報（項目＝内容）</label>
            <div id="extras-list-shop">
              {% set _extras2 = (entry_edit.extras if entry_edit and entry_edit.extras else {}) %}
              {% if _extras2.items is defined %}
                {% for k, v in _extras2.items() %}
                  <div class="extra-row">
                    <input name="extras_key[]" value="{{ k }}" placeholder="項目"> ＝
                    <input name="extras_val[]" value="{{ v }}" placeholder="内容">
                    <button type="button" onclick="this.parentNode.remove()">－</button>
                  </div>
                {% endfor %}
              {% else %}
                <div class="extra-row">
                  <input name="extras_key[]" placeholder="項目"> ＝
                  <input name="extras_val[]" placeholder="内容">
                  <button type="button" onclick="this.parentNode.remove()">－</button>
                </div>
              {% endif %}
            </div>
            <button type="button" class="add-btn" style="background:#5aa;" onclick="addExtraRow('extras-list-shop')">＋ 行を追加</button>
        </div>

        <button class="add-btn" type="submit">{{ '編集' if edit_id else '登録' }}</button>
    </form>

    <!-- ===== 登録済みデータ（検索・絞り込み・並び替え・ページネーション対応） ===== -->
    <hr>
    <h2 style="margin-bottom:8px;">登録済みデータ</h2>

    <div class="filterbar">
      <input type="text" id="f_q" placeholder="キーワード（タイトル/説明/住所/タグ/追加情報/リンク）" oninput="filterCards()">
      <select id="f_cat" onchange="filterCards()">
        <option value="">カテゴリー：すべて</option>
        {% for c in cat_list %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
      <select id="f_area" onchange="filterCards()">
        <option value="">エリア：すべて</option>
        {% for area in area_opts %}
          <option value="{{ area }}">{{ area }}</option>
        {% endfor %}
      </select>
      <input type="text" id="f_tag" placeholder="タグ（カンマ区切り・AND）" oninput="filterCards()">
      <select id="f_sort" onchange="filterCards()">
        <option value="title_asc">並び替え：タイトル↑</option>
        <option value="title_desc">並び替え：タイトル↓</option>
        <option value="cat_asc">並び替え：カテゴリ↑</option>
        <option value="cat_desc">並び替え：カテゴリ↓</option>
      </select>

      <!-- 件数とページサイズ -->
      <span class="badge">表示：<span id="f_count">0</span> / <span id="f_total">0</span></span>
      <select id="f_page_size" onchange="onChangePageSize(this)">
        <option value="10">1ページ 10件</option>
        <option value="20" selected>1ページ 20件</option>
        <option value="30">1ページ 30件</option>
        <option value="50">1ページ 50件</option>
      </select>

      <button class="btn ghost" type="button" onclick="resetFilters()">リセット</button>
    </div>

    <!-- ページャー（上） -->
    <div class="pager">
      <button type="button" class="btn first" onclick="gotoPage('first')">≪ 最初</button>
      <button type="button" class="btn prev"  onclick="gotoPage('prev')">‹ 前へ</button>
      <span class="info">ページ 1 / 1（1ページ 20件）</span>
      <button type="button" class="btn next"  onclick="gotoPage('next')">次へ ›</button>
      <button type="button" class="btn last"  onclick="gotoPage('last')">最後 ≫</button>
    </div>

    <div id="cards">
    {% for e in entries %}
        {# 型ゆれに強い正規化 #}
        {% set _tags = e.tags if e.tags is defined and e.tags is not string
                 else (e.tags | replace('\r\n', ',') | replace('\n', ',') | split(',')) %}
        {% set _areas = e.areas if e.areas is defined and e.areas is not string else (e.areas.split(',') if e.areas else []) %}
        {% set _links = e.links if e.links is defined and e.links is not string
                  else (e.links | replace('\r\n', ',') | replace('\n', ',') | split(',')) %}
        {% set _pay   = e.payment if e.payment is defined and e.payment is not string else (e.payment.split(',') if e.payment else []) %}

        {% set all_text = (e.title ~ ' ' ~ (e.desc or '') ~ ' ' ~ (e.address or '') ~ ' ' ~ ((e.links or []) | join(' ')) ~ ' ' ~ (e.extras | tojson)) | lower %}
        <div class="entry-card"
             data-title="{{ e.title or '' }}"
             data-category="{{ e.category or '' }}"
             data-areas="{{ _areas|join(', ') }}"
             data-tags="{{ (_tags|join(', ')|lower) if _tags else '' }}"
             data-text="{{ all_text }}">
            <span class="card-label">タイトル：</span>{{ e.title }}<br>
            <span class="card-label">説明：</span>{{ e.desc }}<br>
            <span class="card-label">住所：</span>{{ e.address }}<br>
            <span class="card-label">地図：</span>
            {% if e.map %}<a href="{{ e.map }}" target="_blank">MAP</a>{% endif %}<br>
            <span class="card-label">タグ：</span>{{ _tags|join(', ') }}<br>
            <span class="card-label">エリア：</span>{{ _areas|join(', ') }}<br>

            {% if e.category and e.category != "観光" %}
                <span class="card-label">電話：</span>{{ e.tel or "" }}<br>
                <span class="card-label">休み：</span>{{ e.holiday or "" }}<br>
                <span class="card-label">営業時間：</span>{{ e.open_hours or "" }}<br>
                <span class="card-label">駐車場：</span>{{ e.parking or "" }}（{{ e.parking_num or "" }}台）<br>
                <span class="card-label">支払方法：</span>{{ _pay|join(', ') }}<br>
                <span class="card-label">備考：</span>{{ e.remark or "" }}<br>
            {% endif %}

            {% if _links %}
              <span class="card-label">リンク：</span>
              <ul class="compact">
                {% for u in _links %}
                  {% set u2 = (u ~ '') | trim %}
                  {% if u2 %}<li><a href="{{ u2 }}" target="_blank">{{ u2 }}</a></li>{% endif %}
                {% endfor %}
              </ul>
            {% endif %}

            {% if e.extras is defined and e.extras %}
              <span class="card-label">追加情報：</span>
              <table class="kv">
                {% if e.extras.items is defined %}
                  {% for k, v in e.extras.items() %}
                    <tr><td class="k">{{ k }}</td><td>{{ v }}</td></tr>
                  {% endfor %}
                {% elif e.extras is iterable and e.extras is not string %}
                  {% for it in e.extras %}
                    {% if it.items is defined %}
                      {% for k,v in it.items() %}
                        <tr><td class="k">{{ k }}</td><td>{{ v }}</td></tr>
                      {% endfor %}
                    {% else %}
                      <tr><td class="k">{{ it[0] if it|length>0 else '' }}</td><td>{{ it[1] if it|length>1 else '' }}</td></tr>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <tr><td class="k">備考</td><td>{{ e.extras }}</td></tr>
                {% endif %}
              </table>
            {% endif %}

            <span class="card-label">カテゴリー：</span>{{ e.category or "" }}<br>

            <div class="entry-actions">
                <form method="get" action="{{ url_for('admin_entry') }}" style="display:inline;">
                    <input type="hidden" name="edit" value="{{ loop.index0 }}">
                    <button type="submit" class="btn" style="background:#6abf4b;">編集</button>
                </form>
                {% if role == "admin" %}
                <form method="post" action="{{ url_for('delete_entry') }}" style="display:inline;" onsubmit="return confirm('本当に削除しますか？');">
                    <input type="hidden" name="idx" value="{{ loop.index0 }}">
                    <button type="submit" class="del-btn">削除</button>
                </form>
                {% endif %}
            </div>
        </div>
    {% endfor %}
    </div>

    <!-- ページャー（下） -->
    <div class="pager">
      <button type="button" class="btn first" onclick="gotoPage('first')">≪ 最初</button>
      <button type="button" class="btn prev"  onclick="gotoPage('prev')">‹ 前へ</button>
      <span class="info">ページ 1 / 1（1ページ 20件）</span>
      <button type="button" class="btn next"  onclick="gotoPage('next')">次へ ›</button>
      <button type="button" class="btn last"  onclick="gotoPage('last')">最後 ≫</button>
    </div>

</div>
</body>
</html>
