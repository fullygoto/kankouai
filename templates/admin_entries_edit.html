<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>観光データ一括編集（UI）</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","メイリオ",sans-serif;background:#f6faf9;margin:0}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .top{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .btn{padding:8px 14px;border:0;border-radius:8px;background:#2a8ed8;color:#fff;cursor:pointer}
  .btn.secondary{background:#6b7280}
  .btn.danger{background:#e11d48}
  .btn.ghost{background:#fff;border:1px solid #cbd5e1;color:#2a8ed8}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px #c6d4e71a}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;vertical-align:top;font-size:13px}
  th{background:#f1f5f9;text-align:left;white-space:nowrap}
  input[type=text], textarea, select{width:100%;box-sizing:border-box;font-size:13px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
  textarea{min-height:42px;resize:vertical}
  .muted{opacity:.45}
  .row-actions{display:flex;gap:6px}
  .note{font-size:12px;color:#64748b;margin-left:8px}
  .savebar{position:sticky;bottom:0;background:#f6faf9;padding:10px 0;margin-top:10px}
  .csvbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .flash{background:#ecfeff;border:1px solid #bae6fd;color:#075985;padding:8px 10px;border-radius:8px;margin:8px 0}
</style>
<script>
function addRow(){
  const tpl = document.getElementById('row-template');
  const tbody = document.getElementById('tbody');
  const clone = tpl.content.cloneNode(true);
  tbody.appendChild(clone);
}
function removeRow(btn){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
}
function onCategoryChange(sel){
  const tr = sel.closest('tr');
  const isTourism = (sel.value === '観光');
  tr.querySelectorAll('[data-shop]').forEach(el=>{
    el.disabled = isTourism;
    el.classList.toggle('muted', isTourism);
  });
}
window.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('select[name="category[]"]').forEach(onCategoryChange);
});
</script>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1 style="margin:0;font-size:20px;">観光データ一括編集（UI）</h1>
    <span class="note">※タグ/エリア/支払方法はカンマ区切りで入力</span>
    <a class="btn secondary" href="{{ url_for('admin_entry') }}">← 登録フォームへ戻る</a>
  </div>

  <!-- ▼ フラッシュ表示（成功/エラー） -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for m in messages %}
        <div class="flash">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ▼ CSV 取り込み（既存に追加） -->
  <form class="csvbar" method="post" action="{{ url_for('admin_entries_import_csv') }}" enctype="multipart/form-data">
    <input type="file" name="csv_file" accept=".csv">
    <button class="btn" type="submit">CSVを取り込む（既存に追加）</button>
    <span class="note">列：category,title,desc,address,map,tags,areas,links,extras,extra_○○…（title/desc必須）</span>
    <a class="btn ghost" href="{{ url_for('admin_entries_edit') }}">最新の内容を再読込</a>
  </form>

  <!-- ▼ 既存データの編集フォーム（このページの「保存」は従来どおり /admin/entries_edit にPOSTされる想定） -->
  <form method="post">
    <table>
      <thead>
        <tr>
          <th style="width:110px;">カテゴリー</th>
          <th style="width:180px;">タイトル</th>
          <th>説明</th>
          <th style="width:180px;">住所</th>
          <th style="width:180px;">地図URL</th>
          <th style="width:160px;">タグ</th>
          <th style="width:160px;">エリア</th>
          <th style="width:110px;">電話</th>
          <th style="width:120px;">休み</th>
          <th style="width:140px;">営業時間</th>
          <th style="width:90px;">駐車</th>
          <th style="width:70px;">台数</th>
          <th style="width:150px;">支払方法</th>
          <th style="width:160px;">備考</th>
          <th style="width:80px;">操作</th>
        </tr>
      </thead>
      <tbody id="tbody">
        {% for e in entries %}
        <tr>
          <td>
            <select name="category[]" onchange="onCategoryChange(this)">
              {% set cats = ["観光","飲食","宿泊","診療所","役所","交通","バス","イベント","特売"] %}
              {% for c in cats %}
                <option value="{{ c }}" {% if e.category==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="text" name="title[]" value="{{ e.title or '' }}"></td>
          <td><textarea name="desc[]">{{ e.desc or '' }}</textarea></td>
          <td><input type="text" name="address[]" value="{{ e.address or '' }}"></td>
          <td><input type="text" name="map[]" value="{{ e.map or '' }}"></td>
          <td><input type="text" name="tags[]" value="{% if e.tags %}{{ ','.join(e.tags) }}{% endif %}"></td>
          <td><input type="text" name="areas[]" value="{% if e.areas %}{{ ','.join(e.areas) }}{% endif %}"></td>

          <td><input data-shop type="text" name="tel[]" value="{{ e.tel or '' }}"></td>
          <td><input data-shop type="text" name="holiday[]" value="{{ e.holiday or '' }}"></td>
          <td><input data-shop type="text" name="open_hours[]" value="{{ e.open_hours or '' }}"></td>
          <td>
            <select data-shop name="parking[]">
              <option value="" {% if not e.parking %}selected{% endif %}>-</option>
              <option value="あり" {% if e.parking=='あり' %}selected{% endif %}>あり</option>
              <option value="なし" {% if e.parking=='なし' %}selected{% endif %}>なし</option>
            </select>
          </td>
          <td><input data-shop type="text" name="parking_num[]" value="{{ e.parking_num or '' }}"></td>
          <td><input data-shop type="text" name="payment[]" value="{% if e.payment %}{{ ','.join(e.payment) }}{% endif %}"></td>
          <td><input data-shop type="text" name="remark[]" value="{{ e.remark or '' }}"></td>

          <td class="row-actions">
            <button class="btn danger" type="button" onclick="removeRow(this)">削除</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="savebar">
      <button class="btn" type="button" onclick="addRow()">＋ 行を追加</button>
      <button class="btn" type="submit">💾 保存する</button>
    </div>

    <!-- 追加用テンプレート -->
    <template id="row-template">
      <tr>
        <td>
          <select name="category[]" onchange="onCategoryChange(this)">
            <option value="観光" selected>観光</option>
            <option value="飲食">飲食</option>
            <option value="宿泊">宿泊</option>
            <option value="診療所">診療所</option>
            <option value="役所">役所</option>
            <option value="交通">交通</option>
            <option value="バス">バス</option>
            <option value="イベント">イベント</option>
            <option value="特売">特売</option>
          </select>
        </td>
        <td><input type="text" name="title[]" value=""></td>
        <td><textarea name="desc[]"></textarea></td>
        <td><input type="text" name="address[]" value=""></td>
        <td><input type="text" name="map[]" value=""></td>
        <td><input type="text" name="tags[]" value=""></td>
        <td><input type="text" name="areas[]" value=""></td>

        <td><input data-shop type="text" name="tel[]" value=""></td>
        <td><input data-shop type="text" name="holiday[]" value=""></td>
        <td><input data-shop type="text" name="open_hours[]" value=""></td>
        <td>
          <select data-shop name="parking[]">
            <option value="" selected>-</option>
            <option value="あり">あり</option>
            <option value="なし">なし</option>
          </select>
        </td>
        <td><input data-shop type="text" name="parking_num[]" value=""></td>
        <td><input data-shop type="text" name="payment[]" value=""></td>
        <td><input data-shop type="text" name="remark[]" value=""></td>

        <td class="row-actions">
          <button class="btn danger" type="button" onclick="removeRow(this)">削除</button>
        </td>
      </tr>
    </template>
  </form>
</div>
</body>
</html>
