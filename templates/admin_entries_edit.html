<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>観光データ一括編集（UI）</title>
<style>
  :root{
    --bg:#f6faf9; --panel:#fff; --muted:#64748b; --line:#e5e7eb; --brand:#2a8ed8;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","メイリオ",sans-serif;background:var(--bg);margin:0}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .top{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
  .btn{padding:8px 14px;border:0;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
  .btn.secondary{background:#6b7280}
  .btn.danger{background:#e11d48}
  .btn.ghost{background:#fff;border:1px solid #cbd5e1;color:var(--brand)}
  .note{font-size:12px;color:var(--muted);margin-left:8px}
  .flash{background:#ecfeff;border:1px solid #bae6fd;color:#075985;padding:8px 10px;border-radius:8px;margin:8px 0}

  /* simple card */
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 4px 16px #c6d4e71a}
  .card h2{margin:0 0 8px;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  /* 横スクロール用：テーブルをラップして overflow-x */
  .table-wrap{overflow-x:auto;background:var(--panel);border-radius:12px;box-shadow:0 4px 16px #c6d4e71a}
  table{border-collapse:collapse;min-width:1960px;width:100%}
  th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top;font-size:13px;background:#fff}
  thead th{position:sticky;top:0;background:#f1f5f9;text-align:left;white-space:nowrap;z-index:1}
  input[type=text], textarea, select{
    width:100%;font-size:13px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff
  }
  textarea{min-height:72px;resize:vertical;line-height:1.5}
  textarea[name="desc[]"]{font-size:14px}
  .row-actions{display:flex;gap:6px}
  .savebar{position:sticky;bottom:0;background:var(--bg);padding:10px 0;margin-top:10px;display:flex;gap:10px}

  /* CSVバー */
  .csvbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .csvbar input[type=file]{background:#fff;border:1px solid #cbd5e1;border-radius:8px;padding:6px}

  /* JSON全文上書き（上級者） */
  details.jsonbox{margin:16px 0}
  details.jsonbox .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .jsonbox textarea{width:100%;min-height:220px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  summary{cursor:pointer}
  .muted{opacity:.45}

  /* preview list */
  .preview{max-height:240px;overflow:auto;border:1px dashed #cbd5e1;border-radius:8px;padding:8px;background:#fafcff}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#2563eb;font-size:12px;margin-left:6px}
</style>
<script>
function addRow(){
  const tpl = document.getElementById('row-template');
  const tbody = document.getElementById('tbody');
  const clone = tpl.content.cloneNode(true);
  tbody.appendChild(clone);
}
function removeRow(btn){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
}
function onCategoryChange(sel){
  const tr = sel.closest('tr');
  const isTourism = (sel.value === '観光');
  tr.querySelectorAll('[data-shop]').forEach(el=>{
    el.disabled = isTourism;
    el.classList.toggle('muted', isTourism);
  });
}
window.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('select[name="category[]"]').forEach(onCategoryChange);
  const uiForm = document.getElementById('entries-ui-form');
  if(uiForm){
    uiForm.addEventListener('submit', ev=>{
      if(!guardUiSubmit(uiForm)){
        ev.preventDefault();
        ev.stopPropagation();
      }
    });
  }
  const rawForm = document.getElementById('entries-raw-form');
  if(rawForm){
    rawForm.addEventListener('submit', ev=>{
      if(!guardRawSubmit(rawForm)){
        ev.preventDefault();
        ev.stopPropagation();
      }
    });
  }
});

/* ===== 重複統合（AI最適化）プレビュー ===== */
async function previewDedupe(){
  const box = document.getElementById('dedupe_preview');
  const meta = document.getElementById('dedupe_meta');
  box.innerHTML = '読み込み中…';
  meta.textContent = '';
  try{
    const r = await fetch('{{ url_for("admin_entries_dedupe") }}', {credentials:'same-origin'});
    const j = await r.json();
    if(!j || !j.ok){
      box.innerHTML = 'プレビュー取得に失敗しました。';
      return;
    }
    const stats = j.stats || {};
    meta.innerHTML =
      '重複グループ: <b>'+ (stats.merged_groups||0) +'</b> / 統合後件数: <b>'+ (stats.total_after||'-') +'</b>'
      + ' <span class="pill">削除予定: '+ (stats.removed||0) +'</span>';

    const list = (j.preview||[]).map((p,i)=>(
      (i+1)+'. '+ escapeHtml(p.title||'(無題)') +'  <span class="muted">（'+ (p.merged_from||1) +' 件を統合）</span>'
    ));
    box.innerHTML = list.length ? '<ul><li>'+ list.join('</li><li>') +'</li></ul>' : '重複は見つかりませんでした。';
  }catch(e){
    box.innerHTML = 'プレビュー通信エラー: '+ e;
  }
}
function runDedupe(){
  if(confirm('タイトル重複をAI最適化で統合します。よろしいですか？（この操作は元に戻せません。事前にバックアップを推奨）')){
    document.getElementById('dedupe_form').submit();
  }
}
function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function markAllowEmpty(form, allow){
  const hidden = form.querySelector('input[name="allow_empty"]');
  if(hidden){ hidden.value = allow ? '1' : ''; }
}

function guardUiSubmit(form){
  const rows = form.querySelectorAll('#tbody tr');
  for(const tr of rows){
    const title = tr.querySelector('input[name="title[]"]');
    const areas = tr.querySelector('input[name="areas[]"]');
    if(title && areas){
      if(title.value.trim() && areas.value.trim()){
        markAllowEmpty(form, false);
        return true;
      }
    }
  }
  if(confirm('全件を空の状態で保存しようとしています。現在の entries.json は空配列で上書きされます。本当に実行しますか？')){
    markAllowEmpty(form, true);
    return true;
  }
  markAllowEmpty(form, false);
  return false;
}

function guardRawSubmit(form){
  const textarea = form.querySelector('textarea[name="entries_raw"]');
  const raw = textarea ? textarea.value.trim() : '';
  let needsConfirm = false;
  if(!raw){
    needsConfirm = true;
  }else{
    try{
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed) && parsed.length === 0){
        needsConfirm = true;
      }
    }catch(e){
      markAllowEmpty(form, false);
      return true;
    }
  }
  if(needsConfirm){
    if(confirm('0件のデータで entries.json を置換します。現在の内容はすべて削除されます。実行しますか？')){
      markAllowEmpty(form, true);
      return true;
    }
    markAllowEmpty(form, false);
    return false;
  }
  markAllowEmpty(form, false);
  return true;
}
</script>
</head>
<body>
{% include '_back_to_data.html' %}
<div class="wrap">
  {% set _base_cats = ["観光","飲食","宿泊","診療所","役所","交通","バス","イベント","特売"] %}
  {% set _fg_cats = ["求人","五島を贈ろう","観光","泊まる","食べる・呑む","きれい","癒し","ショップ","生活","趣味・習い事"] %}
  {% set _ns = namespace(cats=_base_cats[:]) %}
  {% for c in _fg_cats %}
    {% if c not in _ns.cats %}{% set _ = _ns.cats.append(c) %}{% endif %}
  {% endfor %}
  {% set cat_list = _ns.cats %}
  <div class="top">
    <h1 style="margin:0;font-size:20px;">観光データ一括編集（UI）</h1>
    <span class="note">※タグ/エリア/支払方法はカンマ区切りで入力</span>
    <a class="btn secondary" href="{{ url_for('admin_entry') }}">← 登録フォームへ戻る</a>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for m in messages %}
        <div class="flash">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- サーバ内スナップショット（ZIP）: app.py で snapshots を渡していない場合でも表示は安全です -->
  <div class="card">
    <h2>サーバ内スナップショット（ZIP）</h2>
    <div class="row" style="margin-bottom:8px">
      <form method="post" action="{{ url_for('admin_snapshot_create') }}">
        <button class="btn" type="submit">📦 スナップショットを作成</button>
      </form>
      <span class="note">データ（data/）、画像（static/uploads/・images/）、entries.json をZIPで保存します（アップロード不要）。</span>
    </div>
    {% if snapshots and snapshots|length %}
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
        <form method="post" action="{{ url_for('admin_snapshot_restore') }}"
              onsubmit="return confirm('選択したスナップショットで復元します。現在の内容は上書きされます。よろしいですか？');">
          <select name="fname">
            {% for s in snapshots %}
              <option value="{{ s.name }}">
                {{ s.name }}（{{ (s.size/1048576)|round(1) }} MB / {{ s.mtime.strftime('%Y-%m-%d %H:%M') }}）
              </option>
            {% endfor %}
          </select>
          <button class="btn danger" type="submit">⏪ このスナップショットで復元</button>
        </form>
      </div>
      <ul style="margin:0;padding-left:18px">
        {% for s in snapshots %}
        <li>
          <code>{{ s.name }}</code>
          <span class="note"> — {{ (s.size/1048576)|round(1) }} MB / {{ s.mtime.strftime('%Y-%m-%d %H:%M') }}</span>
          <a class="btn ghost" style="margin-left:8px" href="{{ url_for('admin_snapshot_download', fname=s.name) }}">⬇ ダウンロード</a>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="note">まだスナップショットはありません。「📦 スナップショットを作成」を押すと保存されます。</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>タイトル重複の統合（AI最適化）</h2>
    <div class="row" style="margin-bottom:8px">
      <button class="btn ghost" type="button" onclick="previewDedupe()">👀 プレビューを取得</button>
      <form id="dedupe_form" method="post" action="{{ url_for('admin_entries_dedupe') }}">
        <button class="btn" type="button" onclick="runDedupe()">✨ 統合を実行</button>
      </form>
      <span class="note">※ 説明文はAIで最適化（環境変数 <code>DEDUPE_USE_AI=1</code> 時）。実行前に <a class="btn ghost" href="{{ url_for('admin_backup') }}">バックアップ</a> を推奨。</span>
    </div>
    <div id="dedupe_meta" class="note" style="margin-bottom:6px"></div>
    <div id="dedupe_preview" class="preview">（プレビュー未取得）</div>
  </div>

  <form class="csvbar" method="post" action="{{ url_for('admin_entries_import_csv') }}" enctype="multipart/form-data">
    <input type="file" name="csv_file" accept=".csv">
    <button class="btn" type="submit">CSVを取り込む（既存に追加）</button>
    <span class="note">列：category,title,desc,address,map,tags,areas,links,extras,extra_○○…（title/desc/areas必須）</span>
    <a class="btn ghost" href="{{ url_for('admin_entries_edit') }}">最新の内容を再読込</a>
  </form>

  <details class="jsonbox">
    <summary>JSON全文上書き（上級者向け）を開く</summary>
    <div class="panel">
      <form id="entries-raw-form" method="post" action="{{ url_for('admin_entries_edit') }}">
        <p class="note">このエリアに <code>[{{'{'}} ... {{'}'}}]</code> 形式で <b>entries.json</b> の配列を貼り付けて「上書き保存」を押すと、DBを丸ごと置き換えます。</p>
        <input type="hidden" name="allow_empty" value="">
        <textarea name="entries_raw" placeholder='[
  {"category":"観光","title":"例","desc":"説明","areas":["五島市"],"tags":["教会"],"address":"","map":"","links":[]}
]'></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button class="btn danger" type="submit">⚠ JSONで上書き保存</button>
          <a class="btn ghost" href="{{ url_for('admin_entries_edit') }}">やめる（再読込）</a>
        </div>
      </form>
    </div>
  </details>

  <form id="entries-ui-form" method="post" action="{{ url_for('admin_entries_edit') }}">
    <input type="hidden" name="allow_empty" value="">
    <div class="table-wrap">
      <table>
        <colgroup>
          <!-- 列順を「操作 → カテゴリー → タイトル …」に変更 -->
          <col style="width:110px"><!-- 操作 -->
          <col style="width:110px"><!-- カテゴリー -->
          <col style="width:220px"><!-- タイトル -->
          <col style="width:520px"><!-- 説明 -->
          <col style="width:240px"><!-- 住所 -->
          <col style="width:280px"><!-- 地図URL -->
          <col style="width:220px"><!-- タグ -->
          <col style="width:220px"><!-- エリア -->
          <col style="width:140px"><!-- 電話 -->
          <col style="width:140px"><!-- 休み -->
          <col style="width:180px"><!-- 営業時間 -->
          <col style="width:110px"><!-- 駐車 -->
          <col style="width:90px"><!-- 台数 -->
          <col style="width:200px"><!-- 支払方法 -->
          <col style="width:220px"><!-- 備考 -->
        </colgroup>
        <thead>
          <tr>
            <th>操作</th>
            <th>カテゴリー</th>
            <th>タイトル</th>
            <th>説明</th>
            <th>住所</th>
            <th>地図URL</th>
            <th>タグ</th>
            <th>エリア</th>
            <th>電話</th>
            <th>休み</th>
            <th>営業時間</th>
            <th>駐車</th>
            <th>台数</th>
            <th>支払方法</th>
            <th>備考</th>
          </tr>
        </thead>
        <tbody id="tbody">
          {% for e in entries %}
          <tr>
            <!-- 先頭：削除ボタン + 安定ID/リンク保持のhidden -->
            <td class="row-actions">
              <!-- ★ 安定ID：サーバ側のマージ保存用（未表示フィールド保持） -->
              <input type="hidden" name="row_id[]" value="{{ loop.index0 }}">
              <!-- ★ links[] がテンプレに無い環境でも既存値を保持するための hidden -->
              <input type="hidden" name="links[]" value="{% if e.links %}{{ ','.join(e.links) }}{% endif %}">
              <button class="btn danger" type="button" onclick="removeRow(this)">削除</button>
            </td>

            <td>
              <select name="category[]" onchange="onCategoryChange(this)">
                {% for c in cat_list %}
                  <option value="{{ c }}" {% if e.category == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </td>
            <td><input type="text" name="title[]" value="{{ e.title or '' }}"></td>
            <td><textarea name="desc[]">{{ e.desc or '' }}</textarea></td>
            <td><input type="text" name="address[]" value="{{ e.address or '' }}"></td>
            <td><input type="text" name="map[]" value="{{ e.map or '' }}"></td>
            <td><input type="text" name="tags[]" value="{% if e.tags %}{{ ','.join(e.tags) }}{% endif %}"></td>
            <td><input type="text" name="areas[]" value="{% if e.areas %}{{ ','.join(e.areas) }}{% endif %}"></td>

            <td><input data-shop type="text" name="tel[]" value="{{ e.tel or '' }}"></td>
            <td><input data-shop type="text" name="holiday[]" value="{{ e.holiday or '' }}"></td>
            <td><input data-shop type="text" name="open_hours[]" value="{{ e.open_hours or '' }}"></td>
            <td>
              <select data-shop name="parking[]">
                <option value="" {% if not e.parking %}selected{% endif %}>-</option>
                <option value="あり" {% if e.parking=='あり' %}selected{% endif %}>あり</option>
                <option value="なし" {% if e.parking=='なし' %}selected{% endif %}>なし</option>
              </select>
            </td>
            <td><input data-shop type="text" name="parking_num[]" value="{{ e.parking_num or '' }}"></td>
            <td><input data-shop type="text" name="payment[]" value="{% if e.payment %}{{ ','.join(e.payment) }}{% endif %}"></td>
            <td><input data-shop type="text" name="remark[]" value="{{ e.remark or '' }}"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="savebar">
      <button class="btn" type="button" onclick="addRow()">＋ 行を追加</button>
      <button class="btn" type="submit">💾 保存する</button>
    </div>

    <template id="row-template">
      <tr>
        <!-- 先頭：削除ボタン + 安定ID/リンク保持のhidden -->
        <td class="row-actions">
          <input type="hidden" name="row_id[]" value="">
          <input type="hidden" name="links[]" value="">
          <button class="btn danger" type="button" onclick="removeRow(this)">削除</button>
        </td>

        <td>
          <select name="category[]" onchange="onCategoryChange(this)">
            <option value="観光" selected>観光</option>
            <option value="飲食">飲食</option>
            <option value="宿泊">宿泊</option>
            <option value="診療所">診療所</option>
            <option value="役所">役所</option>
            <option value="交通">交通</option>
            <option value="バス">バス</option>
            <option value="イベント">イベント</option>
            <option value="特売">特売</option>
          </select>
        </td>
        <td><input type="text" name="title[]" value=""></td>
        <td><textarea name="desc[]"></textarea></td>
        <td><input type="text" name="address[]" value=""></td>
        <td><input type="text" name="map[]" value=""></td>
        <td><input type="text" name="tags[]" value=""></td>
        <td><input type="text" name="areas[]" value=""></td>

        <td><input data-shop type="text" name="tel[]" value=""></td>
        <td><input data-shop type="text" name="holiday[]" value=""></td>
        <td><input data-shop type="text" name="open_hours[]" value=""></td>
        <td>
          <select data-shop name="parking[]">
            <option value="" selected>-</option>
            <option value="あり">あり</option>
            <option value="なし">なし</option>
          </select>
        </td>
        <td><input data-shop type="text" name="parking_num[]" value=""></td>
        <td><input data-shop type="text" name="payment[]" value=""></td>
        <td><input data-shop type="text" name="remark[]" value=""></td>
      </tr>
    </template>
  </form>
</div>
</body>
</html>
