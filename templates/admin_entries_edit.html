<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>観光データ一括編集（UI）</title>
<style>
  :root{
    --bg:#f6faf9; --panel:#fff; --muted:#64748b; --line:#e5e7eb; --brand:#2a8ed8;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","メイリオ",sans-serif;background:var(--bg);margin:0}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .top{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
  .btn{padding:8px 14px;border:0;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
  .btn.secondary{background:#6b7280}
  .btn.danger{background:#e11d48}
  .btn.ghost{background:#fff;border:1px solid #cbd5e1;color:var(--brand)}
  .note{font-size:12px;color:var(--muted);margin-left:8px}
  .flash{background:#ecfeff;border:1px solid #bae6fd;color:#075985;padding:8px 10px;border-radius:8px;margin:8px 0}

  /* 横スクロール用：テーブルをラップして overflow-x */
  .table-wrap{overflow-x:auto;background:var(--panel);border-radius:12px;box-shadow:0 4px 16px #c6d4e71a}
  table{border-collapse:collapse;min-width:1900px;width:100%}
  th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top;font-size:13px;background:#fff}
  thead th{position:sticky;top:0;background:#f1f5f9;text-align:left;white-space:nowrap;z-index:1}
  input[type=text], textarea, select{
    width:100%;font-size:13px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff
  }
  textarea{min-height:72px;resize:vertical;line-height:1.5}
  /* 説明カラムは読みやすく少し大きめ文字 */
  textarea[name="desc[]"]{font-size:14px}

  .row-actions{display:flex;gap:6px}
  .savebar{position:sticky;bottom:0;background:var(--bg);padding:10px 0;margin-top:10px;display:flex;gap:10px}

  /* CSVバー */
  .csvbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
  .csvbar input[type=file]{background:#fff;border:1px solid #cbd5e1;border-radius:8px;padding:6px}

  /* JSON全文上書き（上級者） */
  details.jsonbox{margin:16px 0}
  details.jsonbox .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .jsonbox textarea{width:100%;min-height:220px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  summary{cursor:pointer}
  .muted{opacity:.45}
</style>
<script>
function addRow(){
  const tpl = document.getElementById('row-template');
  const tbody = document.getElementById('tbody');
  const clone = tpl.content.cloneNode(true);
  tbody.appendChild(clone);
}
function removeRow(btn){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
}
function onCategoryChange(sel){
  const tr = sel.closest('tr');
  const isTourism = (sel.value === '観光');
  tr.querySelectorAll('[data-shop]').forEach(el=>{
    el.disabled = isTourism;
    el.classList.toggle('muted', isTourism);
  });
}
window.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('select[name="category[]"]').forEach(onCategoryChange);
});
</script>
</head>
<body>
{% include '_back_to_data.html' %}
<div class="wrap">
  <div class="top">
    <h1 style="margin:0;font-size:20px;">観光データ一括編集（UI）</h1>
    <span class="note">※タグ/エリア/支払方法はカンマ区切りで入力</span>
    <a class="btn secondary" href="{{ url_for('admin_entry') }}">← 登録フォームへ戻る</a>
  </div>

  <!-- ▼ フラッシュ表示 -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for m in messages %}
        <div class="flash">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ▼ CSV 取り込み（既存に追加） -->
  <form class="csvbar" method="post" action="{{ url_for('admin_entries_import_csv') }}" enctype="multipart/form-data">
    <input type="file" name="csv_file" accept=".csv">
    <button class="btn" type="submit">CSVを取り込む（既存に追加）</button>
    <span class="note">列：category,title,desc,address,map,tags,areas,links,extras,extra_○○…（title/desc/areas必須）</span>
    <a class="btn ghost" href="{{ url_for('admin_entries_edit') }}">最新の内容を再読込</a>
  </form>

  <!-- ▼ JSON 全文上書き（上級者向け・任意） -->
  <details class="jsonbox">
    <summary>JSON全文上書き（上級者向け）を開く</summary>
    <div class="panel">
      <form method="post" action="{{ url_for('admin_entries_edit') }}">
        <p class="note">このエリアに <code>[{{'{'}} ... {{'}'}}]</code> 形式で <b>entries.json</b> の配列を貼り付けて「上書き保存」を押すと、DBを丸ごと置き換えます。</p>
        <textarea name="entries_raw" placeholder='[
  {"category":"観光","title":"例","desc":"説明","areas":["五島市"],"tags":["教会"],"address":"","map":"","links":[]}
]'></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button class="btn danger" type="submit">⚠ JSONで上書き保存</button>
          <a class="btn ghost" href="{{ url_for('admin_entries_edit') }}">やめる（再読込）</a>
        </div>
      </form>
    </div>
  </details>

  <!-- ▼ 既存データの編集フォーム -->
  <form method="post" action="{{ url_for('admin_entries_edit') }}">
    <div class="table-wrap">
      <table>
        <colgroup>
          <col style="width:110px">
          <col style="width:220px">
          <col style="width:520px">
          <col style="width:240px">
          <col style="width:280px">
          <col style="width:220px">
          <col style="width:220px">
          <col style="width:140px">
          <col style="width:140px">
          <col style="width:180px">
          <col style="width:110px">
          <col style="width:90px">
          <col style="width:200px">
          <col style="width:220px">
          <col style="width:110px">
        </colgroup>
        <thead>
          <tr>
            <th>カテゴリー</th>
            <th>タイトル</th>
            <th>説明</th>
            <th>住所</th>
            <th>地図URL</th>
            <th>タグ</th>
            <th>エリア</th>
            <th>電話</th>
            <th>休み</th>
            <th>営業時間</th>
            <th>駐車</th>
            <th>台数</th>
            <th>支払方法</th>
            <th>備考</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tbody">
          {% for e in entries %}
          <tr>
            <td>
              <select name="category[]" onchange="onCategoryChange(this)">
                {% set cats = ["観光","飲食","宿泊","診療所","役所","交通","バス","イベント","特売"] %}
                {% for c in cats %}
                  <option value="{{ c }}" {% if e.category==c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </td>
            <td><input type="text" name="title[]" value="{{ e.title or '' }}"></td>
            <td><textarea name="desc[]">{{ e.desc or '' }}</textarea></td>
            <td><input type="text" name="address[]" value="{{ e.address or '' }}"></td>
            <td><input type="text" name="map[]" value="{{ e.map or '' }}"></td>
            <td><input type="text" name="tags[]" value="{% if e.tags %}{{ ','.join(e.tags) }}{% endif %}"></td>
            <td><input type="text" name="areas[]" value="{% if e.areas %}{{ ','.join(e.areas) }}{% endif %}"></td>

            <td><input data-shop type="text" name="tel[]" value="{{ e.tel or '' }}"></td>
            <td><input data-shop type="text" name="holiday[]" value="{{ e.holiday or '' }}"></td>
            <td><input data-shop type="text" name="open_hours[]" value="{{ e.open_hours or '' }}"></td>
            <td>
              <select data-shop name="parking[]">
                <option value="" {% if not e.parking %}selected{% endif %}>-</option>
                <option value="あり" {% if e.parking=='あり' %}selected{% endif %}>あり</option>
                <option value="なし" {% if e.parking=='なし' %}selected{% endif %}>なし</option>
              </select>
            </td>
            <td><input data-shop type="text" name="parking_num[]" value="{{ e.parking_num or '' }}"></td>
            <td><input data-shop type="text" name="payment[]" value="{% if e.payment %}{{ ','.join(e.payment) }}{% endif %}"></td>
            <td><input data-shop type="text" name="remark[]" value="{{ e.remark or '' }}"></td>

            <td class="row-actions">
              <button class="btn danger" type="button" onclick="removeRow(this)">削除</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="savebar">
      <button class="btn" type="button" onclick="addRow()">＋ 行を追加</button>
      <button class="btn" type="submit">💾 保存する</button>
    </div>

    <!-- 追加用テンプレート -->
    <template id="row-template">
      <tr>
        <td>
          <select name="category[]" onchange="onCategoryChange(this)">
            <option value="観光" selected>観光</option>
            <option value="飲食">飲食</option>
            <option value="宿泊">宿泊</option>
            <option value="診療所">診療所</option>
            <option value="役所">役所</option>
            <option value="交通">交通</option>
            <option value="バス">バス</option>
            <option value="イベント">イベント</option>
            <option value="特売">特売</option>
          </select>
        </td>
        <td><input type="text" name="title[]" value=""></td>
        <td><textarea name="desc[]"></textarea></td>
        <td><input type="text" name="address[]" value=""></td>
        <td><input type="text" name="map[]" value=""></td>
        <td><input type="text" name="tags[]" value=""></td>
        <td><input type="text" name="areas[]" value=""></td>

        <td><input data-shop type="text" name="tel[]" value=""></td>
        <td><input data-shop type="text" name="holiday[]" value=""></td>
        <td><input data-shop type="text" name="open_hours[]" value=""></td>
        <td>
          <select data-shop name="parking[]">
            <option value="" selected>-</option>
            <option value="あり">あり</option>
            <option value="なし">なし</option>
          </select>
        </td>
        <td><input data-shop type="text" name="parking_num[]" value=""></td>
        <td><input data-shop type="text" name="payment[]" value=""></td>
        <td><input data-shop type="text" name="remark[]" value=""></td>

        <td class="row-actions">
          <button class="btn danger" type="button" onclick="removeRow(this)">削除</button>
        </td>
      </tr>
    </template>
  </form>
</div>
</body>
</html>
