<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>質問・回答ログ</title>
  <style>
    body{font-family:'Segoe UI','メイリオ',sans-serif;background:#f6faf9;margin:0;}
    .container{background:#fff;padding:26px 28px;margin:38px auto;max-width:980px;border-radius:17px;box-shadow:0 4px 20px #b7d3e04d;}
    .nav{margin-bottom:18px;}
    .nav a{margin-right:16px;font-size:1em;color:#2a8ed8;text-decoration:none;font-weight:500;}
    .nav a:hover{text-decoration:underline;}
    h1{margin:0 0 6px 0;}
    .muted{color:#789;font-size:0.92em}
    .log-card{background:#f7faf7;margin:12px 0;border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px #e0e6ed30;}
    .meta{display:flex;flex-wrap:wrap;gap:8px 14px;font-size:0.92em;color:#567;margin-bottom:10px}
    .tag{padding:2px 8px;border-radius:999px;background:#eef6ff;color:#2a8ed8;}
    .hit{background:#e9f8ef;color:#178a49;}
    .miss{background:#fff1f1;color:#c44;}
    .label{font-weight:600;color:#345;margin:6px 0 2px}
    .box{background:#fff;border:1px solid #e6eef2;border-radius:8px;padding:10px 12px;white-space:pre-wrap;word-break:break-word}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{padding:7px 12px;border:none;border-radius:8px;background:#2a8ed8;color:#fff;cursor:pointer}
    .btn.ghost{background:#fff;color:#2a8ed8;border:1px solid #b7d3e0}
    .empty{padding:10px 12px;background:#fff;border:1px dashed #cfe2ef;border-radius:10px;color:#789;margin-top:12px}
    @media (max-width:720px){.container{padding:14px}}
  </style>
  <script>
    function copyText(t){ navigator.clipboard.writeText(t).then(()=>alert('コピーしました')); }
    function fmt(ts){
      try{
        const d=new Date(ts);const y=d.getFullYear();
        const m=('0'+(d.getMonth()+1)).slice(-2);
        const dd=('0'+d.getDate()).slice(-2);
        const hh=('0'+d.getHours()).slice(-2);
        const mm=('0'+d.getMinutes()).slice(-2);
        return `${y}-${m}-${dd} ${hh}:${mm}`;
      }catch(e){ return ts; }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('[data-ts]').forEach(el=>{ el.textContent = fmt(el.getAttribute('data-ts')); });
    });
  </script>
</head>
<body>
  <div class="container">
    <div class="nav" style="float:right;">
      <a href="{{ url_for('admin_logs') }}">[質問・回答ログ]</a>
      <a href="{{ url_for('admin_unhit_questions') }}">[未ヒット質問一覧]</a>
      <a href="{{ url_for('admin_unhit_report') }}">[未ヒット頻出レポート]</a>
      <a href="{{ url_for('admin_synonyms') }}">[類義語辞書管理]</a>
      <a href="{{ url_for('admin_backup') }}">[全体バックアップ]</a>
      <a href="{{ url_for('admin_entries_edit') }}">[観光データ一括編集]</a>
      <a href="{{ url_for('admin_notices') }}">[お知らせ管理]</a>
      <a href="{{ url_for('notices') }}">[お知らせ一覧]</a>
      <a href="{{ url_for('admin_manual') }}" style="margin-right:14px;">[運用マニュアル]</a>
    </div>

    <h1>質問・回答ログ</h1>
    <div class="muted">直近 {{ logs|length }} 件を表示</div>

    {% if not logs %}
      <div class="empty">ログがありません。</div>
    {% endif %}

    {% for item in logs %}
      {% set ts = item.timestamp or item.get('timestamp','') %}
      {% set source = item.source or item.get('source','web') %}
      {% set q = item.question or item.get('question','') %}
      {% set a = item.answer or item.get('answer','') %}
      {% set hit_db = item.hit_db or item.get('hit_db', False) %}
      {% set extra = item.extra or item.get('extra', {}) %}

      <div class="log-card">
        <div class="meta">
          <span class="tag">{{ source|upper }}</span>
          <span class="tag {{ 'hit' if hit_db else 'miss' }}">{{ 'ヒット' if hit_db else '未ヒット' }}</span>
          <span class="muted">日時：<b data-ts="{{ ts }}"></b></span>
          {% if extra and extra.get('kind') %}
            <span class="tag">{{ extra.get('kind') }}</span>
          {% endif %}
        </div>

        <div class="label">Q.</div>
        <div class="box">{{ q }}</div>

        <div class="label">A.</div>
        <div class="box">{{ a }}</div>

        {% if extra and extra.items()|length > 0 %}
          <div class="label">メタ情報</div>
          <div class="box">
            {% for k, v in extra.items() %}
              <div><b>{{ k }}：</b><span style="white-space:pre-wrap">{{ v }}</span></div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="row-actions">
          <button class="btn ghost" onclick="copyText(`{{ q|replace('`','\\`') }}`)">質問をコピー</button>
          <button class="btn ghost" onclick="copyText(`{{ a|replace('`','\\`') }}`)">回答をコピー</button>
          {% if not hit_db %}
            <form method="post" action="{{ url_for('admin_add_entry') }}" style="display:inline;">
              <input type="hidden" name="title" value="{{ q[:80] }}">
              <input type="hidden" name="desc" value="{{ a[:120] }}">
              <input type="hidden" name="tags" value="">
              <input type="hidden" name="areas" value="">
              <button class="btn" type="submit" title="最小情報でDBへ下書き追加（後で編集）">DBに追加</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</body>
</html>
