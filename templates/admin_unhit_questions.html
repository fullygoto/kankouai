<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>未ヒット質問一覧</title>
<style>
  body{font-family:'Segoe UI','メイリオ',sans-serif;background:#f6faf9;margin:0}
  .container{background:#fff;padding:26px 28px;margin:38px auto;max-width:980px;border-radius:17px;box-shadow:0 4px 20px #b7d3e04d;}
  .nav{margin-bottom:18px;}
  .nav a{margin-right:16px;font-size:1em;color:#2a8ed8;text-decoration:none;font-weight:500;}
  .nav a:hover{text-decoration:underline;}
  h1{margin:0 0 10px}
  .muted{color:#789;font-size:.92em}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
  .toolbar input[type=text], .toolbar input[type=date], .toolbar select{padding:8px 10px;border:1px solid #b0c4d7;border-radius:8px;font-size:.96em}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#2a8ed8;font-size:.86em}
  .btn{padding:7px 12px;border:none;border-radius:8px;background:#2a8ed8;color:#fff;cursor:pointer}
  .btn.ghost{background:#fff;color:#2a8ed8;border:1px solid #cfe1ef}
  .btn.secondary{background:#5aa}
  .card{background:#f7faf7;margin:12px 0;border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px #e0e6ed30;}
  .ts{color:#678;font-size:.9em;margin-bottom:6px}
  .q{font-weight:600;margin:2px 0 6px}
  label{display:block;font-weight:600;margin:.5rem 0 .25rem}
  textarea, input[type=text]{width:100%;box-sizing:border-box;border:1px solid #bfd2e2;border-radius:8px;padding:8px 10px;font-size:14px}
  textarea{resize:vertical;min-height:90px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .answer-preview{white-space:pre-wrap;background:#fff;border:1px dashed #d7e6f2;border-radius:8px;padding:8px 10px;margin-top:8px}
  .empty{padding:10px 12px;background:#fff;border:1px dashed #cfe2ef;border-radius:10px;color:#789;margin-top:12px}
  @media (max-width:760px){.row{grid-template-columns:1fr}}
</style>
<script>
function fmt(ts){
  try{
    const d = new Date(ts);
    const y = d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2);
    const dd=('0'+d.getDate()).slice(-2), hh=('0'+d.getHours()).slice(-2);
    const mm=('0'+d.getMinutes()).slice(-2);
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  }catch(e){ return ts; }
}
function copyText(t){ navigator.clipboard.writeText(t).then(()=>alert('コピーしました')); }

async function genFAQ(btn, idx){
  const wrap = document.getElementById('card-'+idx);
  const q = wrap.querySelector('input[name="__q"]').value;
  btn.disabled = true; const orig = btn.textContent; btn.textContent = '生成中…';
  try{
    const form = new FormData(); form.append('q', q);
    const res = await fetch('{{ url_for("api_faq_suggest") }}', {method:'POST', body:form});
    const data = await res.json();
    if(!data.ok){ alert(data.error || '失敗しました'); }
    else{
      wrap.querySelector('textarea[name="desc"]').value = (data.text || '').trim();
    }
  }catch(e){ alert('通信に失敗しました'); }
  finally{ btn.disabled=false; btn.textContent=orig; }
}

function filterCards(){
  const q = (document.getElementById('f_q').value || '').toLowerCase();
  const src = document.getElementById('f_src').value; // all/web/line
  const from = document.getElementById('f_from').value;
  const to   = document.getElementById('f_to').value;

  const cards = document.querySelectorAll('.card[data-text]');
  let shown = 0;
  cards.forEach(card=>{
    const txt = card.dataset.text;
    const source = card.dataset.source;
    const ts = card.dataset.ts;
    let ok = true;
    if(q && !txt.includes(q)) ok = false;
    if(src!=='all' && source!==src) ok = false;
    if(from){ try{ if(new Date(ts) < new Date(from)) ok = false; }catch(e){} }
    if(to){ try{ const d=new Date(to); d.setHours(23,59,59,999); if(new Date(ts) > d) ok=false; }catch(e){} }
    card.style.display = ok ? '' : 'none';
    if(ok) shown++;
  });
  document.getElementById('f_count').textContent = shown;
}
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('[data-tslabel]').forEach(el=>{ el.textContent = fmt(el.getAttribute('data-tslabel')); });
  filterCards();
});
</script>
</head>
<body>
  {% include '_back_to_data.html' %}
  <div class="container">
    <div class="nav" style="float:right;">
      <a href="{{ url_for('admin_logs') }}">[質問・回答ログ]</a>
      <a href="{{ url_for('admin_unhit_questions') }}">[未ヒット質問一覧]</a>
      <a href="{{ url_for('admin_unhit_report') }}">[未ヒット頻出レポート]</a>
      <a href="{{ url_for('admin_synonyms') }}">[類義語辞書管理]</a>
      <a href="{{ url_for('admin_backup') }}">[全体バックアップ]</a>
      <a href="{{ url_for('admin_entries_edit') }}">[観光データ一括編集]</a>
      <a href="{{ url_for('admin_notices') }}">[お知らせ管理]</a>
      <a href="{{ url_for('notices') }}">[お知らせ一覧]</a>
      <a href="{{ url_for('admin_manual') }}" style="margin-right:14px;">[運用マニュアル]</a>
    </div>

    <h1>未ヒット質問一覧</h1>
    <div class="muted">未ヒット（DBに該当がない）と判定されたログを表示します。</div>

    <!-- フィルタ -->
    <div class="toolbar">
      <input type="text" id="f_q" placeholder="キーワード（質問/回答/メタ）" oninput="filterCards()">
      <select id="f_src" onchange="filterCards()">
        <option value="all">ソース：すべて</option>
        <option value="web">Web</option>
        <option value="line">LINE</option>
      </select>
      <span class="muted">期間：</span>
      <input type="date" id="f_from" onchange="filterCards()">〜
      <input type="date" id="f_to" onchange="filterCards()">
      <span class="badge">表示件数：<span id="f_count">0</span></span>
    </div>

    {% if not unhit_logs %}
      <div class="empty">未ヒット質問はありません。</div>
    {% else %}
      {% for log in unhit_logs|reverse %}
        {% set ts = log.timestamp or log.get('timestamp','') %}
        {% set source = log.source or log.get('source','web') %}
        {% set q = log.question or log.get('question','') %}
        {% set a = log.answer or log.get('answer','') %}
        {% set extra = log.extra or log.get('extra', {}) %}

        <div class="card" id="card-{{ loop.index0 }}"
             data-text="{{ (q ~ ' ' ~ a ~ ' ' ~ source ~ ' ' ~ (extra|tojson))|lower }}"
             data-source="{{ source }}"
             data-ts="{{ ts }}">
          <div class="ts">{{ source|upper }} ｜ <span data-tslabel="{{ ts }}"></span></div>
          <div class="q">Q. {{ q }}</div>

          <form method="post" action="{{ url_for('admin_add_entry') }}">
            <label>タイトル（登録名）</label>
            <input type="text" name="title" value="{{ q[:80] }}" required>

            <label>説明（FAQ文）</label>
            <textarea name="desc" placeholder="ここにFAQ文を入れます（AIでFAQ案ボタンで自動生成可）">{{ a }}</textarea>

            <div class="row">
              <div>
                <label>タグ（カンマ区切り）</label>
                <input type="text" name="tags" placeholder="例: 教会, 展望, 温泉">
              </div>
              <div>
                <label>エリア（カンマ区切り）</label>
                <input type="text" name="areas" placeholder="例: 五島市, 新上五島町">
              </div>
            </div>

            <div class="btns">
              <button type="submit" class="btn">DBに追加</button>
              <button type="button" class="btn ghost" onclick="copyText(`{{ q|replace('`','\\`') }}`)">質問をコピー</button>
              <button type="button" class="btn ghost" onclick="copyText(`{{ a|replace('`','\\`') }}`)">回答をコピー</button>
              <button type="button" class="btn secondary" onclick="genFAQ(this, {{ loop.index0 }})">AIでFAQ案</button>
            </div>

            <!-- JS用に元質問を保持（サーバへは送らない） -->
            <input type="hidden" name="__q" value="{{ q }}">
          </form>

          {% if a %}
            <div class="answer-preview">
              <b>回答ログ（参考）</b>\n{{ a }}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  </div>
</body>
</html>
