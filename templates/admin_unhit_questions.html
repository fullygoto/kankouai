<<<<<<< HEAD
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>未ヒット質問一覧</title>
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
  :root{--bg:#f6faf9;--panel:#fff;--muted:#64748b;--line:#e5e7eb;--brand:#2a8ed8;--hit:#178a49;--miss:#c44}
  *{box-sizing:border-box}
  body{font-family:'Segoe UI','メイリオ',sans-serif;background:var(--bg);margin:0}
  .container{background:#fff;padding:26px 28px;margin:38px auto;max-width:1100px;border-radius:17px;box-shadow:0 4px 20px #b7d3e04d}
  .nav{margin-bottom:18px}
  .nav a{margin-right:16px;font-size:1em;color:var(--brand);text-decoration:none;font-weight:500}
  .nav a:hover{text-decoration:underline}
  h1{margin:0 0 10px}
  .muted{color:#789;font-size:.92em}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 16px}
  .toolbar input[type=text], .toolbar input[type=date], .toolbar select{
    padding:8px 10px;border:1px solid #b0c4d7;border-radius:8px;font-size:.96em;background:#fff
  }
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:var(--brand);font-size:.86em}
  .btn{padding:7px 12px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--brand);border:1px solid #cfe1ef}
  .btn.secondary{background:#5aa}
  .btn.warn{background:#c53}

  .card{background:#f7faf7;margin:12px 0;border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px #e0e6ed30}
  .ts{color:#678;font-size:.9em;margin-bottom:6px}
  .q{font-weight:600;margin:2px 0 8px}
  label{display:block;font-weight:600;margin:.5rem 0 .25rem}
  textarea, input[type=text]{width:100%;box-sizing:border-box;border:1px solid #bfd2e2;border-radius:8px;padding:8px 10px;font-size:14px;background:#fff}
  textarea{resize:vertical;min-height:90px}

  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  .answer-preview{white-space:pre-wrap;background:#fff;border:1px dashed #d7e6f2;border-radius:8px;padding:8px 10px;margin-top:8px}
  .empty{padding:10px 12px;background:#fff;border:1px dashed #cfe2ef;border-radius:10px;color:#789;margin-top:12px}

  .mode{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .mode .seg{display:inline-flex;border:1px solid #cfe1ef;border-radius:10px;overflow:hidden}
  .mode .seg button{background:#fff;color:var(--brand);border:none;padding:7px 12px;cursor:pointer}
  .mode .seg button.active{background:var(--brand);color:#fff}

  .box{background:#fff;border:1px solid #e5eff7;border-radius:12px;padding:10px 12px;margin-top:8px}
  .path{font-size:.9em;color:#567}
  .hint{font-size:.86em;color:#567;margin-top:4px}
  .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .row-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
  .row-left{display:flex;gap:10px;align-items:center}

  .done{display:inline-flex;gap:6px;align-items:center}

  .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 6px}
  .pager .btn{padding:6px 10px}

  /* グループ表示 */
  details.group{background:#f7faf7;border-radius:12px;padding:10px 12px;margin:10px 0;border:1px solid #e6eef2}
  details.group summary{cursor:pointer;font-weight:600}
  .g-meta{font-size:.9em;color:#567;margin-left:8px}
  .g-list{margin-top:8px}
  .g-item{border:1px dashed #dbe7f1;background:#fff;border-radius:10px;padding:8px 10px;margin:8px 0}
  .g-q{font-weight:600;margin-bottom:4px}

  @media (max-width:960px){.row2,.row3{grid-template-columns:1fr}}
</style>

<script>
// === CSRF header auto ===
(function(){
  const meta = document.querySelector('meta[name="csrf-token"]');
  const TOKEN = meta ? meta.content : null;
  if(!TOKEN) return;
  if (window.fetch) {
    const _fetch = window.fetch;
    window.fetch = function(input, init){
      init = init || {};
      init.headers = new Headers(init.headers || {});
      if(!init.headers.get('X-CSRF-Token')) init.headers.set('X-CSRF-Token', TOKEN);
      return _fetch(input, init);
    };
  }
  const _open = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(){
    this.addEventListener("readystatechange", () => {
      try { if (this.readyState === 1 && TOKEN) this.setRequestHeader("X-CSRF-Token", TOKEN); } catch(e){}
    });
    return _open.apply(this, arguments);
  };
})();

// === utils ===
function fmt(ts){
  try{
    const d=new Date(ts);
    const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2);
    const dd=('0'+d.getDate()).slice(-2), hh=('0'+d.getHours()).slice(-2);
    const mm=('0'+d.getMinutes()).slice(-2);
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  }catch(e){ return ts; }
}
function copyText(t){ navigator.clipboard.writeText(t).then(()=>alert('コピーしました')); }
function slugify(s){
  return (s||'').toString().trim()
    .replace(/[　\s]+/g,'-')
    .replace(/[^\w\-ぁ-んァ-ヶ一-龯]/g,'')
    .replace(/-+/g,'-')
    .replace(/^-+|-+$/g,'')
    .toLowerCase()
    .slice(0,80) || 'untitled';
}
function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function norm(s){ return (s||'').toString().toLowerCase().trim().replace(/\s+/g,' '); }

// === local processed memory ===
const DONE_KEY = 'unhit_done_keys_v1';
function _loadDone(){ try{ return new Set(JSON.parse(localStorage.getItem(DONE_KEY)||'[]')); }catch{ return new Set(); } }
function _saveDone(set){ localStorage.setItem(DONE_KEY, JSON.stringify(Array.from(set))); }
const DONE = _loadDone();

// === paging & view state ===
let PAGE_SIZE = 20;
let CUR_PAGE = 1;
let VIEW_MODE = 'cards'; // 'cards' | 'group'
let FILTERED_KEYS = [];  // keys after filtering (for paging)

function genKey(ts, src, q){ return btoa(unescape(encodeURIComponent(`${ts}||${src}||${q}`))).slice(0,64); }

// === filters ===
function filterCards(){
  const q = norm(document.getElementById('f_q').value);
  const src = document.getElementById('f_src').value; // all/web/line
  const from = document.getElementById('f_from').value;
  const to   = document.getElementById('f_to').value;
  const hideDone = document.getElementById('f_hide_done').checked;

  const cards = [...document.querySelectorAll('.card[data-key]')];

  FILTERED_KEYS = [];

  for(const card of cards){
    const text = card.dataset.text; // lower 済
    const source = card.dataset.source;
    const ts = card.dataset.ts;
    const key = card.dataset.key;

    let ok = true;
    if(q && !text.includes(q)) ok=false;
    if(src!=='all' && source!==src) ok=false;
    if(from){ try{ if(new Date(ts) < new Date(from)) ok=false; }catch(e){} }
    if(to){ try{ const d=new Date(to); d.setHours(23,59,59,999); if(new Date(ts) > d) ok=false; }catch(e){} }
    if(hideDone && DONE.has(key)) ok=false;

    if(ok) FILTERED_KEYS.push(key);
  }

  CUR_PAGE = 1;
  renderPage();

  document.getElementById('f_count').textContent = FILTERED_KEYS.length;
}

function renderPage(){
  const cards = [...document.querySelectorAll('.card[data-key]')];
  const total = FILTERED_KEYS.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(CUR_PAGE < 1) CUR_PAGE = 1;
  if(CUR_PAGE > totalPages) CUR_PAGE = totalPages;

  const start = (CUR_PAGE-1)*PAGE_SIZE;
  const end   = Math.min(start + PAGE_SIZE, total);
  const pageKeys = new Set(FILTERED_KEYS.slice(start, end));

  if(VIEW_MODE==='cards'){
    for(const card of cards){
      const show = pageKeys.has(card.dataset.key);
      card.style.display = show ? '' : 'none';
    }
    document.getElementById('groups').style.display = 'none';
    document.getElementById('cardswrap').style.display = '';
  }else{
    buildGroups(pageKeys);
    document.getElementById('groups').style.display = '';
    document.getElementById('cardswrap').style.display = 'none';
  }

  const info = `ページ ${CUR_PAGE} / ${totalPages}（1ページ ${PAGE_SIZE}件）`;
  ['pg_info','pg_info2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent = info; });

  const setBtn = (id, dis)=>{ const b=document.getElementById(id); if(b) b.disabled = dis; };
  const atFirst = (CUR_PAGE<=1), atLast = (CUR_PAGE>=totalPages);
  ['pg_prev','pg_first'].forEach(id=>setBtn(id, atFirst));
  ['pg_next','pg_last'].forEach(id=>setBtn(id, atLast));
  ['pg_prev2','pg_first2'].forEach(id=>setBtn(id, atFirst));
  ['pg_next2','pg_last2'].forEach(id=>setBtn(id, atLast));

  document.getElementById('sel_all').checked = false;
}

function gotoPage(w){
  if(w==='first') CUR_PAGE = 1;
  else if(w==='prev') CUR_PAGE -= 1;
  else if(w==='next') CUR_PAGE += 1;
  else if(w==='last'){ const totalPages = Math.max(1, Math.ceil(FILTERED_KEYS.length / PAGE_SIZE)); CUR_PAGE = totalPages; }
  renderPage();
}
function changePageSize(sel){ PAGE_SIZE = parseInt(sel.value||'20',10); CUR_PAGE = 1; renderPage(); }
function setView(mode){
  VIEW_MODE = mode;
  document.querySelectorAll('.viewseg button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.viewseg button[data-mode="${mode}"]`).classList.add('active');
  renderPage();
}
function clearFilters(){
  document.getElementById('f_q').value='';
  document.getElementById('f_src').value='all';
  document.getElementById('f_from').value='';
  document.getElementById('f_to').value='';
  document.getElementById('f_hide_done').checked=false;
  // 下部ミラーも同期
  syncMirrorFromTop();
  filterCards();
}

// === grouping（現在ページのみで軽量構築） ===
function buildGroups(pageKeys){
  const items = [...document.querySelectorAll('.card[data-key]')]
    .filter(c=>pageKeys.has(c.dataset.key))
    .map(c=>({q:c.dataset.q, a:c.dataset.a, ts:c.dataset.ts, source:c.dataset.source}));
  const map = new Map();
  for(const r of items){
    const k = norm(r.q);
    if(!map.has(k)) map.set(k, {q:r.q, items:[], first:r.ts, last:r.ts});
    const g = map.get(k);
    g.items.push(r);
    if(new Date(r.ts) < new Date(g.first)) g.first = r.ts;
    if(new Date(r.ts) > new Date(g.last))  g.last  = r.ts;
  }
  const groups = Array.from(map.values()).sort((a,b)=>new Date(b.last)-new Date(a.last));
  const html = groups.map(g=>{
    const body = g.items.map(it=>`
      <div class="g-item">
        <div class="g-q">[${it.source.toUpperCase()}] ${fmt(it.ts)}</div>
        <div class="label">Q.</div><div class="box">${escapeHtml(it.q)}</div>
        ${it.a ? `<div class="label">A.</div><div class="box">${escapeHtml(it.a)}</div>`:''}
      </div>`).join('');
    return `<details class="group">
      <summary>${escapeHtml(g.q)} <span class="g-meta">（${g.items.length}件｜最古 ${fmt(g.first)} ／ 最新 ${fmt(g.last)}）</span></summary>
      <div class="g-list">${body}</div>
    </details>`;
  }).join('');
  document.getElementById('groups').innerHTML = html || '<div class="empty">該当がありません。</div>';
}

// === selection ===
function toggleSelectAll(box){
  const start = (CUR_PAGE-1)*PAGE_SIZE;
  const pageSet = new Set(FILTERED_KEYS.slice(start, start+PAGE_SIZE));
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    if(pageSet.has(c.dataset.key)){
      const cb = c.querySelector('input.sel');
      if(cb) cb.checked = box.checked;
    }
  });
}
function getSelected(){
  const rows = [];
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    const cb = c.querySelector('input.sel');
    if(cb && cb.checked && c.style.display!=='none'){
      rows.push({
        timestamp: c.dataset.ts,
        source: c.dataset.source,
        question: c.dataset.q,
        answer: c.dataset.a
      });
    }
  });
  return rows;
}

// === exports ===
function exportJSON(){
  const rows = collectFilteredAll(); // フィルタ済み全件
  const blob = new Blob([JSON.stringify(rows, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  download(url, 'unhit_filtered.json');
}
function exportCSV(){
  const rows = collectFilteredAll(); // フィルタ済み全件
  const head = ['timestamp','source','question','answer'];
  const esc = s => `"${(s??'').toString().replace(/"/g,'""').replace(/\r?\n/g,'\\n')}"`;
  const lines = [head.join(',')].concat(rows.map(r=>[r.timestamp,r.source,r.question,r.answer].map(esc).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  download(url, 'unhit_filtered.csv');
}
function exportCSVForEntries(){
  const rows = getSelected();
  if(!rows.length){ alert('エクスポートする項目を選択してください（左のチェックボックス）'); return; }
  const head = ['category','title','desc','address','map','tags','areas','links'];
  const esc = s => `"${(s??'').toString().replace(/"/g,'""').replace(/\r?\n/g,'\\n')}"`;
  const lines = [head.join(',')].concat(rows.map(r=>[
    '観光', r.question.slice(0,80), (r.answer||'').slice(0,400), '', '', '', '', ''
  ].map(esc).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  download(url, 'entries_import_from_unhit.csv');
  alert('CSVをダウンロードしました。「観光データ一括編集」画面のCSV取り込みで追加できます。');
}
function collectFilteredAll(){
  const set = new Set(FILTERED_KEYS);
  const rows = [];
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    if(set.has(c.dataset.key)){
      rows.push({
        timestamp: c.dataset.ts,
        source: c.dataset.source,
        question: c.dataset.q,
        answer: c.dataset.a
      });
    }
  });
  return rows;
}
function download(url, filename){
  const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

// === per-card handlers ===
function setMode(idx, mode){
  const root = document.getElementById('card-'+idx);
  root.querySelectorAll('.mode .seg button').forEach(b=>b.classList.remove('active'));
  root.querySelector(`.mode .seg button[data-mode="${mode}"]`).classList.add('active');
  root.querySelector('.box.db').style.display   = (mode==='db')?'':'none';
  root.querySelector('.box.txt').style.display  = (mode==='txt')?'':'none';
}
async function genFAQ(btn, idx){
  const wrap = document.getElementById('card-'+idx);
  const q = wrap.querySelector('input[name="__q"]').value;
  btn.disabled = true; const orig = btn.textContent; btn.textContent = '生成中…';
  try{
    const form = new FormData(); form.append('q', q);
    const res = await fetch('{{ url_for("api_faq_suggest") }}', {method:'POST', body:form});
    const data = await res.json();
    if(!data.ok){ alert(data.error || '失敗しました'); }
    else{ wrap.querySelector('textarea[name="desc"]').value = (data.text || '').trim(); }
  }catch(e){ alert('通信に失敗しました'); }
  finally{ btn.disabled=false; btn.textContent=orig; }
}
async function genSummary(btn, idx){
  const root = document.getElementById('card-'+idx);
  const src  = (root.querySelector('textarea[name="desc"]').value || '').trim();
  if(!src){ alert('説明/本文を先に入力してください'); return; }
  btn.disabled = true; const orig = btn.textContent; btn.textContent = '要約中…';
  try{
    const fd = new FormData(); fd.append('text', src);
    const res = await fetch('{{ url_for("api_text_summarize") }}', {method:'POST', body:fd});
    const data = await res.json();
    if(!data.ok){ alert(data.error || '要約に失敗しました'); }
    else{ root.querySelector('textarea[name="text_short"]').value = (data.summary||'').trim(); }
  }catch(e){ alert('通信に失敗しました'); }
  finally{ btn.disabled=false; btn.textContent=orig; }
}
function fillSlug(idx){
  const root = document.getElementById('card-'+idx);
  const title = (root.querySelector('input[name="title"]').value||'').trim();
  const q = (root.querySelector('input[name="__q"]').value||'').trim();
  root.querySelector('input[name="slug"]').value = slugify(title || q);
}
function openEntryWithPrefill(idx){
  const root = document.getElementById('card-'+idx);
  const base = '{{ url_for("admin_entry") }}';
  const params = new URLSearchParams({
    prefill: 1,
    title: root.querySelector('input[name="title"]').value || '',
    desc:  root.querySelector('textarea[name="desc"]').value || '',
    tags:  root.querySelector('input[name="tags"]').value || '',
    areas: root.querySelector('input[name="areas"]').value || ''
  });
  window.open(base + '?' + params.toString(), '_blank');
}
function markDone(cb, key){
  if(cb.checked){ DONE.add(key); } else { DONE.delete(key); }
  _saveDone(DONE);
  if(document.getElementById('f_hide_done').checked) filterCards();
}

// === top/bottom filter mirror ===
function syncMirrorFromTop(){
  const map = [
    ['f_q','f_q_bottom'],
    ['f_src','f_src_bottom'],
    ['f_from','f_from_bottom'],
    ['f_to','f_to_bottom'],
    ['f_hide_done','f_hide_done_bottom'],
  ];
  for(const [t,b] of map){
    const te = document.getElementById(t), be = document.getElementById(b);
    if(te && be){
      if(be.type==='checkbox'){ be.checked = te.checked; } else { be.value = te.value; }
    }
  }
}
function wireMirror(){
  const pairs = [
    ['f_q','f_q_bottom','input'],
    ['f_src','f_src_bottom','change'],
    ['f_from','f_from_bottom','change'],
    ['f_to','f_to_bottom','change'],
    ['f_hide_done','f_hide_done_bottom','change'],
  ];
  for(const [top,bottom,ev] of pairs){
    const te = document.getElementById(top), be = document.getElementById(bottom);
    if(!te || !be) continue;
    te.addEventListener(ev, ()=>{ syncMirrorFromTop(); filterCards(); });
    be.addEventListener(ev, ()=>{ // bottom -> top
      if(te.type==='checkbox'){ te.checked = be.checked; } else { te.value = be.value; }
      filterCards();
    });
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  // init stamps/keys & done check
  document.querySelectorAll('[data-tslabel]').forEach(el=>{ el.textContent = fmt(el.getAttribute('data-tslabel')); });
  document.querySelectorAll('.card[data-key]').forEach((card, i)=>{
    const key = card.dataset.key;
    const chk = card.querySelector('input.donebox');
    if(chk){ chk.checked = DONE.has(key); }
    // 既定モード
    const db = card.querySelector('.box.db'), txt = card.querySelector('.box.txt');
    if(db && txt){ db.style.display=''; txt.style.display='none'; }
  });

  wireMirror();
  syncMirrorFromTop();

  filterCards(); // 初回フィルタ→描画
});
</script>
</head>
<body>
  {% include '_back_to_data.html' %}
  <div class="container">
    <div class="nav" style="float:right;">
      <a href="{{ url_for('admin_logs') }}">[質問・回答ログ]</a>
      <a href="{{ url_for('admin_unhit_questions') }}">[未ヒット質問一覧]</a>
      <a href="{{ url_for('admin_unhit_report') }}">[未ヒット頻出レポート]</a>
      <a href="{{ url_for('admin_synonyms') }}">[類義語辞書管理]</a>
      <a href="{{ url_for('admin_backup') }}">[全体バックアップ]</a>
      <a href="{{ url_for('admin_entries_edit') }}">[観光データ一括編集]</a>
      <a href="{{ url_for('admin_notices') }}">[お知らせ管理]</a>
      <a href="{{ url_for('notices') }}">[お知らせ一覧]</a>
      <a href="{{ url_for('admin_manual') }}" style="margin-right:14px;">[運用マニュアル]</a>
    </div>

    <h1>未ヒット質問一覧</h1>
    <div class="muted">未ヒット（DBに該当がない）ログから、観光DB追加 または data への要約テキスト保存を行えます。</div>

    <!-- ▼ 上部：フィルタ＆ビュー＆エクスポート -->
    <div class="toolbar">
      <input type="text" id="f_q" placeholder="キーワード（質問/回答/メタ）" oninput="filterCards()">
      <select id="f_src" onchange="filterCards()">
        <option value="all">ソース：すべて</option>
        <option value="web">Web</option>
        <option value="line">LINE</option>
      </select>
      <span class="muted">期間：</span>
      <input type="date" id="f_from" onchange="filterCards()">〜
      <input type="date" id="f_to" onchange="filterCards()">
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input type="checkbox" id="f_hide_done" onchange="filterCards()"> 処理済みを隠す
      </label>
      <span class="badge">表示：<span id="f_count">0</span>件</span>

      <div class="viewseg" style="margin-left:auto;display:inline-flex;border:1px solid #cfe1ef;border-radius:10px;overflow:hidden">
        <button type="button" data-mode="cards" class="active" onclick="setView('cards')" style="background:#fff;color:var(--brand);border:none;padding:7px 12px">カード</button>
        <button type="button" data-mode="group" onclick="setView('group')" style="background:#fff;color:var(--brand);border:none;padding:7px 12px">質問でグループ</button>
      </div>
      <button class="btn ghost" type="button" onclick="exportJSON()">JSON出力</button>
      <button class="btn ghost" type="button" onclick="exportCSV()">CSV出力</button>
      <button class="btn ghost" type="button" onclick="clearFilters()">フィルタをクリア</button>
    </div>

    <!-- ▼ ページャ（上） -->
    <div class="pager">
      <label>1ページ件数：
        <select onchange="changePageSize(this)">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
        </select>
      </label>
      <button id="pg_first" class="btn ghost" type="button" onclick="gotoPage('first')">≪ 最初</button>
      <button id="pg_prev"  class="btn ghost" type="button" onclick="gotoPage('prev')">‹ 前へ</button>
      <span class="muted" id="pg_info">ページ 1 / 1（1ページ 20件）</span>
      <button id="pg_next" class="btn ghost" type="button" onclick="gotoPage('next')">次へ ›</button>
      <button id="pg_last" class="btn ghost" type="button" onclick="gotoPage('last')">最後 ≫</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label style="display:inline-flex;gap:6px;align-items:center"><input id="sel_all" type="checkbox" onclick="toggleSelectAll(this)"> このページを全選択</label>
        <button class="btn ghost" type="button" onclick="exportCSVForEntries()">選択→CSV（DB取り込み用）</button>
      </div>
    </div>

    {% if not unhit_logs %}
      <div class="empty">未ヒット質問はありません。</div>
    {% else %}

      <!-- ▼ カード一覧 -->
      <div id="cardswrap">
        {% for log in unhit_logs|reverse %}
          {% set ts = log.timestamp or log.get('timestamp','') %}
          {% set source = log.source or log.get('source','web') %}
          {% set q = log.question or log.get('question','') %}
          {% set a = log.answer or log.get('answer','') %}
          {% set extra = log.extra or log.get('extra', {}) %}
          {% set _key = (ts ~ '||' ~ source ~ '||' ~ q) %}

          <div class="card"
               id="card-{{ loop.index0 }}"
               data-key="{{ _key|b64encode }}"
               data-q="{{ q }}"
               data-a="{{ a }}"
               data-source="{{ source }}"
               data-ts="{{ ts }}"
               data-text="{{ (q ~ ' ' ~ a ~ ' ' ~ source ~ ' ' ~ (extra|tojson))|lower }}">
            <div class="row-head">
              <div class="row-left">
                <input class="sel" type="checkbox" title="選択">
                <div class="done">
                  <input class="donebox" type="checkbox" onchange="markDone(this, '{{ _key|b64encode }}')" id="done-{{ loop.index0 }}">
                  <label for="done-{{ loop.index0 }}" class="muted">処理済み</label>
                </div>
              </div>
              <div class="right ts">
                <span>{{ source|upper }} ｜ <span data-tslabel="{{ ts }}"></span></span>
                <button type="button" class="btn ghost" onclick="copyText(`{{ q|replace('`','\\`') }}`)">質問コピー</button>
                {% if a %}<button type="button" class="btn ghost" onclick="copyText(`{{ a|replace('`','\\`') }}`)">回答コピー</button>{% endif %}
              </div>
            </div>

            <div class="q">Q. {{ q }}</div>

            <div class="mode">
              <span class="muted">保存先：</span>
              <div class="seg">
                <button type="button" data-mode="db"  class="active" onclick="setMode({{ loop.index0 }}, 'db')">観光DB</button>
                <button type="button" data-mode="txt"               onclick="setMode({{ loop.index0 }}, 'txt')">テキスト（data）</button>
              </div>
            </div>

            <!-- 観光DB 登録ボックス -->
            <div class="box db">
              <form method="post" action="{{ url_for('admin_add_entry') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="__q" value="{{ q }}">

                <label>タイトル（登録名）</label>
                <input type="text" name="title" value="{{ q[:80] }}" required>

                <label>説明（短文・FAQ文でも可）</label>
                <textarea name="desc" placeholder="ここに説明（FAQでも可）">{{ a }}</textarea>

                <div class="row3">
                  <div>
                    <label>タグ（カンマ区切り）</label>
                    <input type="text" name="tags" placeholder="例: 教会, 展望, 温泉">
                  </div>
                  <div>
                    <label>エリア（カンマ区切り）</label>
                    <input type="text" name="areas" placeholder="例: 五島市, 新上五島町">
                  </div>
                  <div>
                    <label>カテゴリ</label>
                    <input type="text" name="category" placeholder="例: 観光">
                  </div>
                </div>

                <div class="row2">
                  <div>
                    <label>住所</label>
                    <input type="text" name="address" placeholder="任意">
                  </div>
                  <div>
                    <label>地図URL</label>
                    <input type="text" name="map" placeholder="https://...">
                  </div>
                </div>

                <div class="row2">
                  <div>
                    <label>座標コピペ欄（URL / 緯度,経度 / DMS）</label>
                    <input type="text" name="coords" placeholder="例）35.681236, 139.767125 ／ https://maps.app.goo.gl/...">
                  </div>
                  <div>
                    <label>緯度・経度（任意）</label>
                    <input type="text" name="latlng" placeholder="32.695123, 128.845678">
                  </div>
                </div>

                <div class="btns">
                  <button type="submit" class="btn">DBに追加</button>
                  <button type="button" class="btn ghost" onclick="openEntryWithPrefill({{ loop.index0 }})">詳細を編集画面で開く</button>
                  <button type="button" class="btn secondary" onclick="genFAQ(this, {{ loop.index0 }})">AIでFAQ案</button>
                </div>
              </form>
            </div>

            <!-- data 保存ボックス -->
            <div class="box txt" style="display:none">
              <form method="post" action="{{ url_for('admin_unhit_save_text') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="original_question" value="{{ q }}">
                <div class="row3">
                  <div>
                    <label>タイプ</label>
                    <select name="dtype">
                      <option value="faq">FAQ（短文回答）</option>
                      <option value="course">コース/モデルプラン</option>
                      <option value="tips">コツ/注意点/その他</option>
                    </select>
                  </div>
                  <div>
                    <label>保存名（スラッグ）</label>
                    <input type="text" name="slug" placeholder="自動生成可">
                    <div class="hint"><button type="button" class="btn ghost" onclick="fillSlug({{ loop.index0 }})">自動生成</button></div>
                  </div>
                  <div>
                    <label>タグ（カンマ区切り）</label>
                    <input type="text" name="tags" placeholder="例: 祭り, 家族向け">
                  </div>
                </div>

                <div class="row2">
                  <div>
                    <label>対象エリア（任意・カンマ区切り）</label>
                    <input type="text" name="areas" placeholder="例: 五島市, 新上五島町">
                  </div>
                  <div class="path" style="align-self:end">
                    実ファイルは <b>data/</b> に保存されます（ファイル名はサーバ側で自動採番）
                  </div>
                </div>

                <label>本文（詳細・長文 / サーバ送信名: text_full）</label>
                <textarea name="text_full" placeholder="長文本文。空でも送信可（空なら『説明』を本文として転用）"></textarea>

                <div class="row2">
                  <div>
                    <label>説明（短文・要約元に利用可）</label>
                    <textarea name="desc">{{ a }}</textarea>
                  </div>
                  <div>
                    <label>要約（回答用の短文 / サーバ送信名: text_short）</label>
                    <textarea name="text_short" placeholder="300〜600字目安。『AIで要約』可。"></textarea>
                    <div class="btns" style="margin-top:6px">
                      <button type="button" class="btn secondary" onclick="genSummary(this, {{ loop.index0 }})">AIで要約</button>
                    </div>
                  </div>
                </div>

                <div class="btns">
                  <button type="submit" class="btn">data に保存</button>
                  <button type="button" class="btn ghost" onclick="copyText((this.closest('form').querySelector('textarea[name=text_short]').value||'').trim())">要約をコピー</button>
                </div>

                <!-- 既定：タイトルは質問から -->
                <input type="hidden" name="title" value="{{ q[:80] }}">
              </form>

              {% if a %}
                <div class="answer-preview">
                  <b>参考ログの回答（元テキスト）</b>\n{{ a }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- ▼ グループ表示エリア -->
      <div id="groups" style="display:none"></div>

    {% endif %}

    <!-- ▼ ページャ（下） -->
    <div class="pager">
      <button id="pg_first2" class="btn ghost" type="button" onclick="gotoPage('first')">≪ 最初</button>
      <button id="pg_prev2"  class="btn ghost" type="button" onclick="gotoPage('prev')">‹ 前へ</button>
      <span class="muted" id="pg_info2">ページ 1 / 1（1ページ 20件）</span>
      <button id="pg_next2" class="btn ghost" type="button" onclick="gotoPage('next')">次へ ›</button>
      <button id="pg_last2" class="btn ghost" type="button" onclick="gotoPage('last')">最後 ≫</button>
    </div>

    <!-- ▼ 下部：フィルタのミラー（長いページ対策） -->
    <div class="toolbar">
      <input type="text" id="f_q_bottom" placeholder="キーワード（質問/回答/メタ）">
      <select id="f_src_bottom">
        <option value="all">ソース：すべて</option>
        <option value="web">Web</option>
        <option value="line">LINE</option>
      </select>
      <span class="muted">期間：</span>
      <input type="date" id="f_from_bottom">〜
      <input type="date" id="f_to_bottom">
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input type="checkbox" id="f_hide_done_bottom"> 処理済みを隠す
      </label>
      <button class="btn ghost" type="button" onclick="exportJSON()">JSON出力</button>
      <button class="btn ghost" type="button" onclick="exportCSV()">CSV出力</button>
      <button class="btn ghost" type="button" onclick="clearFilters()">フィルタをクリア</button>
    </div>

  </div>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>未ヒット質問一覧</title>
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
  :root{--bg:#f6faf9;--panel:#fff;--muted:#64748b;--line:#e5e7eb;--brand:#2a8ed8;--hit:#178a49;--miss:#c44}
  *{box-sizing:border-box}
  body{font-family:'Segoe UI','メイリオ',sans-serif;background:var(--bg);margin:0}
  .container{background:#fff;padding:26px 28px;margin:38px auto;max-width:1100px;border-radius:17px;box-shadow:0 4px 20px #b7d3e04d}
  .nav{margin-bottom:18px}
  .nav a{margin-right:16px;font-size:1em;color:var(--brand);text-decoration:none;font-weight:500}
  .nav a:hover{text-decoration:underline}
  h1{margin:0 0 10px}
  .muted{color:#789;font-size:.92em}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 16px}
  .toolbar input[type=text], .toolbar input[type=date], .toolbar select{
    padding:8px 10px;border:1px solid #b0c4d7;border-radius:8px;font-size:.96em;background:#fff
  }
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:var(--brand);font-size:.86em}
  .btn{padding:7px 12px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--brand);border:1px solid #cfe1ef}
  .btn.secondary{background:#5aa}
  .btn.warn{background:#c53}

  .card{background:#f7faf7;margin:12px 0;border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px #e0e6ed30}
  .ts{color:#678;font-size:.9em;margin-bottom:6px}
  .q{font-weight:600;margin:2px 0 8px}
  label{display:block;font-weight:600;margin:.5rem 0 .25rem}
  textarea, input[type=text]{width:100%;box-sizing:border-box;border:1px solid #bfd2e2;border-radius:8px;padding:8px 10px;font-size:14px;background:#fff}
  textarea{resize:vertical;min-height:90px}

  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  .answer-preview{white-space:pre-wrap;background:#fff;border:1px dashed #d7e6f2;border-radius:8px;padding:8px 10px;margin-top:8px}
  .empty{padding:10px 12px;background:#fff;border:1px dashed #cfe2ef;border-radius:10px;color:#789;margin-top:12px}

  .mode{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .mode .seg{display:inline-flex;border:1px solid #cfe1ef;border-radius:10px;overflow:hidden}
  .mode .seg button{background:#fff;color:var(--brand);border:none;padding:7px 12px;cursor:pointer}
  .mode .seg button.active{background:var(--brand);color:#fff}

  .box{background:#fff;border:1px solid #e5eff7;border-radius:12px;padding:10px 12px;margin-top:8px}
  .path{font-size:.9em;color:#567}
  .hint{font-size:.86em;color:#567;margin-top:4px}
  .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .row-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
  .row-left{display:flex;gap:10px;align-items:center}

  .done{display:inline-flex;gap:6px;align-items:center}

  .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 6px}
  .pager .btn{padding:6px 10px}

  /* グループ表示 */
  details.group{background:#f7faf7;border-radius:12px;padding:10px 12px;margin:10px 0;border:1px solid #e6eef2}
  details.group summary{cursor:pointer;font-weight:600}
  .g-meta{font-size:.9em;color:#567;margin-left:8px}
  .g-list{margin-top:8px}
  .g-item{border:1px dashed #dbe7f1;background:#fff;border-radius:10px;padding:8px 10px;margin:8px 0}
  .g-q{font-weight:600;margin-bottom:4px}

  @media (max-width:960px){.row2,.row3{grid-template-columns:1fr}}
</style>

<script>
// === CSRF header auto ===
(function(){
  const meta = document.querySelector('meta[name="csrf-token"]');
  const TOKEN = meta ? meta.content : null;
  if(!TOKEN) return;
  if (window.fetch) {
    const _fetch = window.fetch;
    window.fetch = function(input, init){
      init = init || {};
      init.headers = new Headers(init.headers || {});
      if(!init.headers.get('X-CSRF-Token')) init.headers.set('X-CSRF-Token', TOKEN);
      return _fetch(input, init);
    };
  }
  const _open = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(){
    this.addEventListener("readystatechange", () => {
      try { if (this.readyState === 1 && TOKEN) this.setRequestHeader("X-CSRF-Token", TOKEN); } catch(e){}
    });
    return _open.apply(this, arguments);
  };
})();

// === utils ===
function fmt(ts){
  try{
    const d=new Date(ts);
    const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2);
    const dd=('0'+d.getDate()).slice(-2), hh=('0'+d.getHours()).slice(-2);
    const mm=('0'+d.getMinutes()).slice(-2);
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  }catch(e){ return ts; }
}
function copyText(t){ navigator.clipboard.writeText(t).then(()=>alert('コピーしました')); }
function slugify(s){
  return (s||'').toString().trim()
    .replace(/[　\s]+/g,'-')
    .replace(/[^\w\-ぁ-んァ-ヶ一-龯]/g,'')
    .replace(/-+/g,'-')
    .replace(/^-+|-+$/g,'')
    .toLowerCase()
    .slice(0,80) || 'untitled';
}
function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function norm(s){ return (s||'').toString().toLowerCase().trim().replace(/\s+/g,' '); }

// === local processed memory ===
const DONE_KEY = 'unhit_done_keys_v1';
function _loadDone(){ try{ return new Set(JSON.parse(localStorage.getItem(DONE_KEY)||'[]')); }catch{ return new Set(); } }
function _saveDone(set){ localStorage.setItem(DONE_KEY, JSON.stringify(Array.from(set))); }
const DONE = _loadDone();

// === paging & view state ===
let PAGE_SIZE = 20;
let CUR_PAGE = 1;
let VIEW_MODE = 'cards'; // 'cards' | 'group'
let FILTERED_KEYS = [];  // keys after filtering (for paging)

function genKey(ts, src, q){ return btoa(unescape(encodeURIComponent(`${ts}||${src}||${q}`))).slice(0,64); }

// === filters ===
function filterCards(){
  const q = norm(document.getElementById('f_q').value);
  const src = document.getElementById('f_src').value; // all/web/line
  const from = document.getElementById('f_from').value;
  const to   = document.getElementById('f_to').value;
  const hideDone = document.getElementById('f_hide_done').checked;

  const cards = [...document.querySelectorAll('.card[data-key]')];

  FILTERED_KEYS = [];

  for(const card of cards){
    const text = card.dataset.text; // lower 済
    const source = card.dataset.source;
    const ts = card.dataset.ts;
    const key = card.dataset.key;

    let ok = true;
    if(q && !text.includes(q)) ok=false;
    if(src!=='all' && source!==src) ok=false;
    if(from){ try{ if(new Date(ts) < new Date(from)) ok=false; }catch(e){} }
    if(to){ try{ const d=new Date(to); d.setHours(23,59,59,999); if(new Date(ts) > d) ok=false; }catch(e){} }
    if(hideDone && DONE.has(key)) ok=false;

    if(ok) FILTERED_KEYS.push(key);
  }

  CUR_PAGE = 1;
  renderPage();

  document.getElementById('f_count').textContent = FILTERED_KEYS.length;
}

function renderPage(){
  const cards = [...document.querySelectorAll('.card[data-key]')];
  const total = FILTERED_KEYS.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(CUR_PAGE < 1) CUR_PAGE = 1;
  if(CUR_PAGE > totalPages) CUR_PAGE = totalPages;

  const start = (CUR_PAGE-1)*PAGE_SIZE;
  const end   = Math.min(start + PAGE_SIZE, total);
  const pageKeys = new Set(FILTERED_KEYS.slice(start, end));

  if(VIEW_MODE==='cards'){
    for(const card of cards){
      const show = pageKeys.has(card.dataset.key);
      card.style.display = show ? '' : 'none';
    }
    document.getElementById('groups').style.display = 'none';
    document.getElementById('cardswrap').style.display = '';
  }else{
    buildGroups(pageKeys);
    document.getElementById('groups').style.display = '';
    document.getElementById('cardswrap').style.display = 'none';
  }

  const info = `ページ ${CUR_PAGE} / ${totalPages}（1ページ ${PAGE_SIZE}件）`;
  ['pg_info','pg_info2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent = info; });

  const setBtn = (id, dis)=>{ const b=document.getElementById(id); if(b) b.disabled = dis; };
  const atFirst = (CUR_PAGE<=1), atLast = (CUR_PAGE>=totalPages);
  ['pg_prev','pg_first'].forEach(id=>setBtn(id, atFirst));
  ['pg_next','pg_last'].forEach(id=>setBtn(id, atLast));
  ['pg_prev2','pg_first2'].forEach(id=>setBtn(id, atFirst));
  ['pg_next2','pg_last2'].forEach(id=>setBtn(id, atLast));

  document.getElementById('sel_all').checked = false;
}

function gotoPage(w){
  if(w==='first') CUR_PAGE = 1;
  else if(w==='prev') CUR_PAGE -= 1;
  else if(w==='next') CUR_PAGE += 1;
  else if(w==='last'){ const totalPages = Math.max(1, Math.ceil(FILTERED_KEYS.length / PAGE_SIZE)); CUR_PAGE = totalPages; }
  renderPage();
}
function changePageSize(sel){ PAGE_SIZE = parseInt(sel.value||'20',10); CUR_PAGE = 1; renderPage(); }
function setView(mode){
  VIEW_MODE = mode;
  document.querySelectorAll('.viewseg button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.viewseg button[data-mode="${mode}"]`).classList.add('active');
  renderPage();
}
function clearFilters(){
  document.getElementById('f_q').value='';
  document.getElementById('f_src').value='all';
  document.getElementById('f_from').value='';
  document.getElementById('f_to').value='';
  document.getElementById('f_hide_done').checked=false;
  // 下部ミラーも同期
  syncMirrorFromTop();
  filterCards();
}

// === grouping（現在ページのみで軽量構築） ===
function buildGroups(pageKeys){
  const items = [...document.querySelectorAll('.card[data-key]')]
    .filter(c=>pageKeys.has(c.dataset.key))
    .map(c=>({q:c.dataset.q, a:c.dataset.a, ts:c.dataset.ts, source:c.dataset.source}));
  const map = new Map();
  for(const r of items){
    const k = norm(r.q);
    if(!map.has(k)) map.set(k, {q:r.q, items:[], first:r.ts, last:r.ts});
    const g = map.get(k);
    g.items.push(r);
    if(new Date(r.ts) < new Date(g.first)) g.first = r.ts;
    if(new Date(r.ts) > new Date(g.last))  g.last  = r.ts;
  }
  const groups = Array.from(map.values()).sort((a,b)=>new Date(b.last)-new Date(a.last));
  const html = groups.map(g=>{
    const body = g.items.map(it=>`
      <div class="g-item">
        <div class="g-q">[${it.source.toUpperCase()}] ${fmt(it.ts)}</div>
        <div class="label">Q.</div><div class="box">${escapeHtml(it.q)}</div>
        ${it.a ? `<div class="label">A.</div><div class="box">${escapeHtml(it.a)}</div>`:''}
      </div>`).join('');
    return `<details class="group">
      <summary>${escapeHtml(g.q)} <span class="g-meta">（${g.items.length}件｜最古 ${fmt(g.first)} ／ 最新 ${fmt(g.last)}）</span></summary>
      <div class="g-list">${body}</div>
    </details>`;
  }).join('');
  document.getElementById('groups').innerHTML = html || '<div class="empty">該当がありません。</div>';
}

// === selection ===
function toggleSelectAll(box){
  const start = (CUR_PAGE-1)*PAGE_SIZE;
  const pageSet = new Set(FILTERED_KEYS.slice(start, start+PAGE_SIZE));
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    if(pageSet.has(c.dataset.key)){
      const cb = c.querySelector('input.sel');
      if(cb) cb.checked = box.checked;
    }
  });
}
function getSelected(){
  const rows = [];
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    const cb = c.querySelector('input.sel');
    if(cb && cb.checked && c.style.display!=='none'){
      rows.push({
        timestamp: c.dataset.ts,
        source: c.dataset.source,
        question: c.dataset.q,
        answer: c.dataset.a
      });
    }
  });
  return rows;
}

// === exports ===
function exportJSON(){
  const rows = collectFilteredAll(); // フィルタ済み全件
  const blob = new Blob([JSON.stringify(rows, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  download(url, 'unhit_filtered.json');
}
function exportCSV(){
  const rows = collectFilteredAll(); // フィルタ済み全件
  const head = ['timestamp','source','question','answer'];
  const esc = s => `"${(s??'').toString().replace(/"/g,'""').replace(/\r?\n/g,'\\n')}"`;
  const lines = [head.join(',')].concat(rows.map(r=>[r.timestamp,r.source,r.question,r.answer].map(esc).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  download(url, 'unhit_filtered.csv');
}
function exportCSVForEntries(){
  const rows = getSelected();
  if(!rows.length){ alert('エクスポートする項目を選択してください（左のチェックボックス）'); return; }
  const head = ['category','title','desc','address','map','tags','areas','links'];
  const esc = s => `"${(s??'').toString().replace(/"/g,'""').replace(/\r?\n/g,'\\n')}"`;
  const lines = [head.join(',')].concat(rows.map(r=>[
    '観光', r.question.slice(0,80), (r.answer||'').slice(0,400), '', '', '', '', ''
  ].map(esc).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  download(url, 'entries_import_from_unhit.csv');
  alert('CSVをダウンロードしました。「観光データ一括編集」画面のCSV取り込みで追加できます。');
}
function collectFilteredAll(){
  const set = new Set(FILTERED_KEYS);
  const rows = [];
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    if(set.has(c.dataset.key)){
      rows.push({
        timestamp: c.dataset.ts,
        source: c.dataset.source,
        question: c.dataset.q,
        answer: c.dataset.a
      });
    }
  });
  return rows;
}
function download(url, filename){
  const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

// === per-card handlers ===
function setMode(idx, mode){
  const root = document.getElementById('card-'+idx);
  root.querySelectorAll('.mode .seg button').forEach(b=>b.classList.remove('active'));
  root.querySelector(`.mode .seg button[data-mode="${mode}"]`).classList.add('active');
  root.querySelector('.box.db').style.display   = (mode==='db')?'':'none';
  root.querySelector('.box.txt').style.display  = (mode==='txt')?'':'none';
}
async function genFAQ(btn, idx){
  const wrap = document.getElementById('card-'+idx);
  const q = wrap.querySelector('input[name="__q"]').value;
  btn.disabled = true; const orig = btn.textContent; btn.textContent = '生成中…';
  try{
    const form = new FormData(); form.append('q', q);
    const res = await fetch('{{ url_for("api_faq_suggest") }}', {method:'POST', body:form});
    const data = await res.json();
    if(!data.ok){ alert(data.error || '失敗しました'); }
    else{ wrap.querySelector('textarea[name="desc"]').value = (data.text || '').trim(); }
  }catch(e){ alert('通信に失敗しました'); }
  finally{ btn.disabled=false; btn.textContent=orig; }
}
async function genSummary(btn, idx){
  const root = document.getElementById('card-'+idx);
  const src  = (root.querySelector('textarea[name="desc"]').value || '').trim();
  if(!src){ alert('説明/本文を先に入力してください'); return; }
  btn.disabled = true; const orig = btn.textContent; btn.textContent = '要約中…';
  try{
    const fd = new FormData(); fd.append('text', src);
    const res = await fetch('{{ url_for("api_text_summarize") }}', {method:'POST', body:fd});
    const data = await res.json();
    if(!data.ok){ alert(data.error || '要約に失敗しました'); }
    else{ root.querySelector('textarea[name="text_short"]').value = (data.summary||'').trim(); }
  }catch(e){ alert('通信に失敗しました'); }
  finally{ btn.disabled=false; btn.textContent=orig; }
}
function fillSlug(idx){
  const root = document.getElementById('card-'+idx);
  const title = (root.querySelector('input[name="title"]').value||'').trim();
  const q = (root.querySelector('input[name="__q"]').value||'').trim();
  root.querySelector('input[name="slug"]').value = slugify(title || q);
}
function openEntryWithPrefill(idx){
  const root = document.getElementById('card-'+idx);
  const base = '{{ url_for("admin_entry") }}';
  const params = new URLSearchParams({
    prefill: 1,
    title: root.querySelector('input[name="title"]').value || '',
    desc:  root.querySelector('textarea[name="desc"]').value || '',
    tags:  root.querySelector('input[name="tags"]').value || '',
    areas: root.querySelector('input[name="areas"]').value || ''
  });
  window.open(base + '?' + params.toString(), '_blank');
}
function markDone(cb, key){
  if(cb.checked){ DONE.add(key); } else { DONE.delete(key); }
  _saveDone(DONE);
  if(document.getElementById('f_hide_done').checked) filterCards();
}

// === top/bottom filter mirror ===
function syncMirrorFromTop(){
  const map = [
    ['f_q','f_q_bottom'],
    ['f_src','f_src_bottom'],
    ['f_from','f_from_bottom'],
    ['f_to','f_to_bottom'],
    ['f_hide_done','f_hide_done_bottom'],
  ];
  for(const [t,b] of map){
    const te = document.getElementById(t), be = document.getElementById(b);
    if(te && be){
      if(be.type==='checkbox'){ be.checked = te.checked; } else { be.value = te.value; }
    }
  }
}
function wireMirror(){
  const pairs = [
    ['f_q','f_q_bottom','input'],
    ['f_src','f_src_bottom','change'],
    ['f_from','f_from_bottom','change'],
    ['f_to','f_to_bottom','change'],
    ['f_hide_done','f_hide_done_bottom','change'],
  ];
  for(const [top,bottom,ev] of pairs){
    const te = document.getElementById(top), be = document.getElementById(bottom);
    if(!te || !be) continue;
    te.addEventListener(ev, ()=>{ syncMirrorFromTop(); filterCards(); });
    be.addEventListener(ev, ()=>{ // bottom -> top
      if(te.type==='checkbox'){ te.checked = be.checked; } else { te.value = be.value; }
      filterCards();
    });
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  // init stamps/keys & done check
  document.querySelectorAll('[data-tslabel]').forEach(el=>{ el.textContent = fmt(el.getAttribute('data-tslabel')); });
  document.querySelectorAll('.card[data-key]').forEach((card, i)=>{
    const key = card.dataset.key;
    const chk = card.querySelector('input.donebox');
    if(chk){ chk.checked = DONE.has(key); }
    // 既定モード
    const db = card.querySelector('.box.db'), txt = card.querySelector('.box.txt');
    if(db && txt){ db.style.display=''; txt.style.display='none'; }
  });

  wireMirror();
  syncMirrorFromTop();

  filterCards(); // 初回フィルタ→描画
});
</script>
</head>
<body>
  {% include '_back_to_data.html' %}
  <div class="container">
    <div class="nav" style="float:right;">
      <a href="{{ url_for('admin_logs') }}">[質問・回答ログ]</a>
      <a href="{{ url_for('admin_unhit_questions') }}">[未ヒット質問一覧]</a>
      <a href="{{ url_for('admin_unhit_report') }}">[未ヒット頻出レポート]</a>
      <a href="{{ url_for('admin_synonyms') }}">[類義語辞書管理]</a>
      <a href="{{ url_for('admin_backup') }}">[全体バックアップ]</a>
      <a href="{{ url_for('admin_entries_edit') }}">[観光データ一括編集]</a>
      <a href="{{ url_for('admin_notices') }}">[お知らせ管理]</a>
      <a href="{{ url_for('notices') }}">[お知らせ一覧]</a>
      <a href="{{ url_for('admin_manual') }}" style="margin-right:14px;">[運用マニュアル]</a>
    </div>

    <h1>未ヒット質問一覧</h1>
    <div class="muted">未ヒット（DBに該当がない）ログから、観光DB追加 または data への要約テキスト保存を行えます。</div>

    <!-- ▼ 上部：フィルタ＆ビュー＆エクスポート -->
    <div class="toolbar">
      <input type="text" id="f_q" placeholder="キーワード（質問/回答/メタ）" oninput="filterCards()">
      <select id="f_src" onchange="filterCards()">
        <option value="all">ソース：すべて</option>
        <option value="web">Web</option>
        <option value="line">LINE</option>
      </select>
      <span class="muted">期間：</span>
      <input type="date" id="f_from" onchange="filterCards()">〜
      <input type="date" id="f_to" onchange="filterCards()">
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input type="checkbox" id="f_hide_done" onchange="filterCards()"> 処理済みを隠す
      </label>
      <span class="badge">表示：<span id="f_count">0</span>件</span>

      <div class="viewseg" style="margin-left:auto;display:inline-flex;border:1px solid #cfe1ef;border-radius:10px;overflow:hidden">
        <button type="button" data-mode="cards" class="active" onclick="setView('cards')" style="background:#fff;color:var(--brand);border:none;padding:7px 12px">カード</button>
        <button type="button" data-mode="group" onclick="setView('group')" style="background:#fff;color:var(--brand);border:none;padding:7px 12px">質問でグループ</button>
      </div>
      <button class="btn ghost" type="button" onclick="exportJSON()">JSON出力</button>
      <button class="btn ghost" type="button" onclick="exportCSV()">CSV出力</button>
      <button class="btn ghost" type="button" onclick="clearFilters()">フィルタをクリア</button>
    </div>

    <!-- ▼ ページャ（上） -->
    <div class="pager">
      <label>1ページ件数：
        <select onchange="changePageSize(this)">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
        </select>
      </label>
      <button id="pg_first" class="btn ghost" type="button" onclick="gotoPage('first')">≪ 最初</button>
      <button id="pg_prev"  class="btn ghost" type="button" onclick="gotoPage('prev')">‹ 前へ</button>
      <span class="muted" id="pg_info">ページ 1 / 1（1ページ 20件）</span>
      <button id="pg_next" class="btn ghost" type="button" onclick="gotoPage('next')">次へ ›</button>
      <button id="pg_last" class="btn ghost" type="button" onclick="gotoPage('last')">最後 ≫</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label style="display:inline-flex;gap:6px;align-items:center"><input id="sel_all" type="checkbox" onclick="toggleSelectAll(this)"> このページを全選択</label>
        <button class="btn ghost" type="button" onclick="exportCSVForEntries()">選択→CSV（DB取り込み用）</button>
      </div>
    </div>

    {% if not unhit_logs %}
      <div class="empty">未ヒット質問はありません。</div>
    {% else %}

      <!-- ▼ カード一覧 -->
      <div id="cardswrap">
        {% for log in unhit_logs|reverse %}
          {% set ts = log.timestamp or log.get('timestamp','') %}
          {% set source = log.source or log.get('source','web') %}
          {% set q = log.question or log.get('question','') %}
          {% set a = log.answer or log.get('answer','') %}
          {% set extra = log.extra or log.get('extra', {}) %}
          {% set _key = (ts ~ '||' ~ source ~ '||' ~ q) %}

          <div class="card"
               id="card-{{ loop.index0 }}"
               data-key="{{ _key|b64encode }}"
               data-q="{{ q }}"
               data-a="{{ a }}"
               data-source="{{ source }}"
               data-ts="{{ ts }}"
               data-text="{{ (q ~ ' ' ~ a ~ ' ' ~ source ~ ' ' ~ (extra|tojson))|lower }}">
            <div class="row-head">
              <div class="row-left">
                <input class="sel" type="checkbox" title="選択">
                <div class="done">
                  <input class="donebox" type="checkbox" onchange="markDone(this, '{{ _key|b64encode }}')" id="done-{{ loop.index0 }}">
                  <label for="done-{{ loop.index0 }}" class="muted">処理済み</label>
                </div>
              </div>
              <div class="right ts">
                <span>{{ source|upper }} ｜ <span data-tslabel="{{ ts }}"></span></span>
                <button type="button" class="btn ghost" onclick="copyText(`{{ q|replace('`','\\`') }}`)">質問コピー</button>
                {% if a %}<button type="button" class="btn ghost" onclick="copyText(`{{ a|replace('`','\\`') }}`)">回答コピー</button>{% endif %}
              </div>
            </div>

            <div class="q">Q. {{ q }}</div>

            <div class="mode">
              <span class="muted">保存先：</span>
              <div class="seg">
                <button type="button" data-mode="db"  class="active" onclick="setMode({{ loop.index0 }}, 'db')">観光DB</button>
                <button type="button" data-mode="txt"               onclick="setMode({{ loop.index0 }}, 'txt')">テキスト（data）</button>
              </div>
            </div>

            <!-- 観光DB 登録ボックス -->
            <div class="box db">
              <form method="post" action="{{ url_for('admin_add_entry') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="__q" value="{{ q }}">

                <label>タイトル（登録名）</label>
                <input type="text" name="title" value="{{ q[:80] }}" required>

                <label>説明（短文・FAQ文でも可）</label>
                <textarea name="desc" placeholder="ここに説明（FAQでも可）">{{ a }}</textarea>

                <div class="row3">
                  <div>
                    <label>タグ（カンマ区切り）</label>
                    <input type="text" name="tags" placeholder="例: 教会, 展望, 温泉">
                  </div>
                  <div>
                    <label>エリア（カンマ区切り）</label>
                    <input type="text" name="areas" placeholder="例: 五島市, 新上五島町">
                  </div>
                  <div>
                    <label>カテゴリ</label>
                    <input type="text" name="category" placeholder="例: 観光">
                  </div>
                </div>

                <div class="row2">
                  <div>
                    <label>住所</label>
                    <input type="text" name="address" placeholder="任意">
                  </div>
                  <div>
                    <label>地図URL</label>
                    <input type="text" name="map" placeholder="https://...">
                  </div>
                </div>

                <div class="row2">
                  <div>
                    <label>座標コピペ欄（URL / 緯度,経度 / DMS）</label>
                    <input type="text" name="coords" placeholder="例）35.681236, 139.767125 ／ https://maps.app.goo.gl/...">
                  </div>
                  <div>
                    <label>緯度・経度（任意）</label>
                    <input type="text" name="latlng" placeholder="32.695123, 128.845678">
                  </div>
                </div>

                <div class="btns">
                  <button type="submit" class="btn">DBに追加</button>
                  <button type="button" class="btn ghost" onclick="openEntryWithPrefill({{ loop.index0 }})">詳細を編集画面で開く</button>
                  <button type="button" class="btn secondary" onclick="genFAQ(this, {{ loop.index0 }})">AIでFAQ案</button>
                </div>
              </form>
            </div>

            <!-- data 保存ボックス -->
            <div class="box txt" style="display:none">
              <form method="post" action="{{ url_for('admin_unhit_save_text') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="original_question" value="{{ q }}">
                <div class="row3">
                  <div>
                    <label>タイプ</label>
                    <select name="dtype">
                      <option value="faq">FAQ（短文回答）</option>
                      <option value="course">コース/モデルプラン</option>
                      <option value="tips">コツ/注意点/その他</option>
                    </select>
                  </div>
                  <div>
                    <label>保存名（スラッグ）</label>
                    <input type="text" name="slug" placeholder="自動生成可">
                    <div class="hint"><button type="button" class="btn ghost" onclick="fillSlug({{ loop.index0 }})">自動生成</button></div>
                  </div>
                  <div>
                    <label>タグ（カンマ区切り）</label>
                    <input type="text" name="tags" placeholder="例: 祭り, 家族向け">
                  </div>
                </div>

                <div class="row2">
                  <div>
                    <label>対象エリア（任意・カンマ区切り）</label>
                    <input type="text" name="areas" placeholder="例: 五島市, 新上五島町">
                  </div>
                  <div class="path" style="align-self:end">
                    実ファイルは <b>data/</b> に保存されます（ファイル名はサーバ側で自動採番）
                  </div>
                </div>

                <label>本文（詳細・長文 / サーバ送信名: text_full）</label>
                <textarea name="text_full" placeholder="長文本文。空でも送信可（空なら『説明』を本文として転用）"></textarea>

                <div class="row2">
                  <div>
                    <label>説明（短文・要約元に利用可）</label>
                    <textarea name="desc">{{ a }}</textarea>
                  </div>
                  <div>
                    <label>要約（回答用の短文 / サーバ送信名: text_short）</label>
                    <textarea name="text_short" placeholder="300〜600字目安。『AIで要約』可。"></textarea>
                    <div class="btns" style="margin-top:6px">
                      <button type="button" class="btn secondary" onclick="genSummary(this, {{ loop.index0 }})">AIで要約</button>
                    </div>
                  </div>
                </div>

                <div class="btns">
                  <button type="submit" class="btn">data に保存</button>
                  <button type="button" class="btn ghost" onclick="copyText((this.closest('form').querySelector('textarea[name=text_short]').value||'').trim())">要約をコピー</button>
                </div>

                <!-- 既定：タイトルは質問から -->
                <input type="hidden" name="title" value="{{ q[:80] }}">
              </form>

              {% if a %}
                <div class="answer-preview">
                  <b>参考ログの回答（元テキスト）</b>\n{{ a }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- ▼ グループ表示エリア -->
      <div id="groups" style="display:none"></div>

    {% endif %}

    <!-- ▼ ページャ（下） -->
    <div class="pager">
      <button id="pg_first2" class="btn ghost" type="button" onclick="gotoPage('first')">≪ 最初</button>
      <button id="pg_prev2"  class="btn ghost" type="button" onclick="gotoPage('prev')">‹ 前へ</button>
      <span class="muted" id="pg_info2">ページ 1 / 1（1ページ 20件）</span>
      <button id="pg_next2" class="btn ghost" type="button" onclick="gotoPage('next')">次へ ›</button>
      <button id="pg_last2" class="btn ghost" type="button" onclick="gotoPage('last')">最後 ≫</button>
    </div>

    <!-- ▼ 下部：フィルタのミラー（長いページ対策） -->
    <div class="toolbar">
      <input type="text" id="f_q_bottom" placeholder="キーワード（質問/回答/メタ）">
      <select id="f_src_bottom">
        <option value="all">ソース：すべて</option>
        <option value="web">Web</option>
        <option value="line">LINE</option>
      </select>
      <span class="muted">期間：</span>
      <input type="date" id="f_from_bottom">〜
      <input type="date" id="f_to_bottom">
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input type="checkbox" id="f_hide_done_bottom"> 処理済みを隠す
      </label>
      <button class="btn ghost" type="button" onclick="exportJSON()">JSON出力</button>
      <button class="btn ghost" type="button" onclick="exportCSV()">CSV出力</button>
      <button class="btn ghost" type="button" onclick="clearFilters()">フィルタをクリア</button>
    </div>

  </div>
</body>
</html>
>>>>>>> origin/import/windows-snapshot
