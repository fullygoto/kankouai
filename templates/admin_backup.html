<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>全体バックアップ / 復元</title>
<style>
  body{font-family:'Segoe UI','メイリオ',sans-serif;background:#f6faf9;margin:0}
  .container{background:#fff;padding:26px 28px;margin:38px auto;max-width:980px;border-radius:17px;box-shadow:0 4px 20px #b7d3e04d;}
  .nav{margin-bottom:18px;}
  .nav a{margin-right:16px;font-size:1em;color:#2a8ed8;text-decoration:none;font-weight:500;}
  .nav a:hover{text-decoration:underline;}
  h1{margin:0 0 10px}
  .muted{color:#789;font-size:.92em}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fbfefe;border:1px solid #e6edf3;border-radius:12px;padding:16px}
  .btn{padding:9px 16px;border:none;border-radius:9px;background:#2a8ed8;color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap}
  .btn.ghost{background:#fff;color:#2a8ed8;border:1px solid #cfe1ef}
  .btn.danger{background:#e11d48}
  .btn.gray{background:#64748b}
  .flash{background:#ecfeff;border:1px solid #bae6fd;color:#075985;padding:8px 10px;border-radius:8px;margin:8px 0}
  input[type=file],input[type=url]{padding:8px;border:1px solid #cfe1ef;border-radius:8px;background:#fff;width:100%}
  ul{margin:8px 0 0 18px}
  li{margin:4px 0}
  .kv{border-collapse:collapse;margin-top:8px}
  .kv td{border:1px solid #e6edf3;padding:6px 8px}
  .kv td.k{background:#f6f9fb;font-weight:600;color:#345;min-width:140px}
  /* 追加: レイアウト崩れ対策（ボタン行 & 入力行） */
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .actions .btn{flex:0 1 auto}
  .input-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .input-row input[type=url]{flex:1 1 280px;min-width:200px}
  .input-row .btn{flex:0 0 auto}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
  code{background:#f3f4f6;padding:0 4px;border-radius:4px}
</style>
<script>
function confirmRestore(){ return confirm('現在のデータが上書きされます。本当に復元しますか？'); }
async function showStorage(){
  const el = document.getElementById('storage');
  el.textContent = '読み込み中…';
  try{
    const r = await fetch('{{ url_for("admin_storage_stats") }}');
    const j = await r.json();
    function human(n){
      const u=['B','KB','MB','GB','TB']; let i=0; let x=Number(n||0);
      while(x>=1024 && i<u.length-1){ x/=1024; i++; }
      return x.toFixed(1)+' '+u[i];
    }
    let html = '<table class="kv">';
    html += '<tr><td class="k">BASE_DIR</td><td>'+ (j.base_dir||'') +'</td></tr>';
    for(const [k,v] of Object.entries(j.dirs||{})){
      html += '<tr><td class="k">'+k+'</td><td>'+human(v.bytes)+' / '+(v.files||0)+' files</td></tr>';
    }
    for(const [k,v] of Object.entries(j.files||{})){
      html += '<tr><td class="k">'+k+'</td><td>'+human(v.bytes)+'</td></tr>';
    }
    html += '</table>';
    el.innerHTML = html;
  }catch(e){
    el.textContent = '取得に失敗しました: '+e;
  }
}
</script>
</head>
<body>
  {% include '_back_to_data.html' %}
  <div class="container">
    {% include '_admin_nav.html' %}

    <h1>全体バックアップ / 復元</h1>
    <div class="muted">
      データをZIPでまとめてエクスポート／インポートできます。<br>
      サーバー上のスナップショット保持は<strong>最新 {{ stats.keep_limit or 3 }} 件</strong>までです。
      容量不足時は<strong>ストリーミング（tar.gz）</strong>をご利用ください。
    </div>

    <!-- フラッシュ表示 -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for m in messages %}<div class="flash">{{ m }}</div>{% endfor %}
      {% endif %}
    {% endwith %}

    <div class="grid" style="margin-top:10px">
      <!-- バックアップ作成 -->
      <div class="card">
        <h2 style="margin:0 0 8px">バックアップの作成</h2>
        <p class="muted">現在の保存内容をダウンロードします。</p>
        <div class="actions">
          <a class="btn" href="{{ url_for('admin_backup', download='1') }}">ZIPを作成してダウンロード</a>
          <a class="btn gray" href="{{ url_for('admin_backup', stream='1') }}">容量不足のとき：ストリーミング（tar.gz）</a>
          <button class="btn ghost" type="button" onclick="location.reload()">再読込</button>
          <button class="btn ghost" type="button" onclick="showStorage()">サーバーの容量状況を表示</button>
        </div>

        {% if stats %}
          <table class="kv" style="margin-top:8px">
            <tr><td class="k">観光データ（entries）</td><td>{{ stats.entries_count }} 件</td></tr>
            <tr><td class="k">類義語（synonyms）</td><td>{{ stats.synonyms_count }} 語</td></tr>
            <tr><td class="k">お知らせ（notices）</td><td>{{ stats.notices_count }} 件</td></tr>
            <tr><td class="k">ログ（logs）</td><td>{{ stats.logs_count }} 件</td></tr>
          </table>
          <div id="storage" class="muted" style="margin-top:8px"></div>
        {% endif %}
      </div>

      <!-- 復元（上書き） -->
      <div class="card">
        <h2 style="margin:0 0 8px">全体復元（ZIPアップロード）</h2>
        <p class="muted">
          ZIPの内容で現在のデータを<strong>上書き</strong>します。<br>
          事前に「バックアップの作成」で退避しておくことを推奨します。
        </p>
        <form method="post" action="{{ url_for('admin_restore') }}" enctype="multipart/form-data" onsubmit="return confirmRestore()">
          <input type="file" name="backup_zip" accept=".zip">
          <div class="actions">
            <button class="btn danger" type="submit">ZIPをアップロードして復元</button>
          </div>
        </form>
        <ul class="muted">
          <li>ZIP直下に <code>entries.json</code>, <code>synonyms.json</code>, <code>notices.json</code> 等が入っている構成を想定</li>
          <li>パスがサブフォルダになっていると復元に失敗します（例：<code>data/entries.json</code> は不可）</li>
        </ul>
      </div>
    </div>

    <!-- URLから復元（10MB制限回避） -->
    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 8px">URLから復元（ブラウザの10MB制限を回避）</h2>
      <p class="muted">
        Google Drive / Dropbox / S3 などに置いた ZIP の<strong>直リンク</strong>を指定すると、<br>
        サーバー側が直接ダウンロードして復元します。
      </p>
      <form method="post" action="{{ url_for('admin_restore_from_url') }}" onsubmit="return confirmRestore()">
        <div class="input-row">
          <input type="url" name="backup_url" placeholder="https://example.com/your-backup.zip" required>
          <button class="btn danger" type="submit">URLから復元</button>
        </div>
      </form>
      <ul class="muted">
        <li>推奨：S3 の<strong>署名付きURL</strong>や Dropbox/Drive の<strong>ダイレクトリンク</strong></li>
        <li>サイズ上限は環境変数 <code>RESTORE_URL_MAX_MB</code>（既定 200MB）で変更できます</li>
        <li>安全のため、ローカル/プライベートIP向けURLは使用できません</li>
      </ul>

      <!-- 使い方：Dropbox の直リンク -->
      <div class="muted" style="margin-top:8px">
        <details>
          <summary><strong>Dropbox の直リンクの作り方（このフォームに貼るURL）</strong></summary>
          <ol style="margin-top:6px">
            <li>DropboxでZIPファイルを右クリック → <b>リンクを作成 / 共有</b> → <b>リンクをコピー</b>。</li>
            <li>リンクの末尾が <code>dl=0</code> になっている場合、<b><code>dl=1</code>に書き換える</b>か、<br>
                ドメインを <code>www.dropbox.com</code> → <code>dl.dropboxusercontent.com</code> に変えて貼り付けます。</li>
          </ol>
          <pre><code>例（共有リンク）:
https://www.dropbox.com/s/ABCDEFG12345/my-backup.zip?dl=0

→ そのまま使える直ダウンロード:
https://www.dropbox.com/s/ABCDEFG12345/my-backup.zip?dl=1

→ あるいは（直ドメイン版）:
https://dl.dropboxusercontent.com/s/ABCDEFG12345/my-backup.zip</code></pre>
          <ul>
            <li>リンクのアクセス権は <b>「リンクを知っている全員」</b>にしてください（ログイン必須だとサーバー側で取得できません）。</li>
            <li>Dropboxのリダイレクトにも対応しています（このアプリは自動追従）。</li>
          </ul>
        </details>
      </div>
    </div>

    <!-- 参考：バックアップに含まれる想定ファイル -->
    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 8px">バックアップの中身（想定）</h2>
      <ul>
        <li><code>entries.json</code> … 観光データ本体</li>
        <li><code>synonyms.json</code> … 並義語辞書</li>
        <li><code>notices.json</code> … お知らせ一覧</li>
        <li>（任意）<code>logs</code> ディレクトリや画像など</li>
      </ul>
      <p class="muted">構成はアプリ実装に依存します。異なる場合はこの説明だけ調整してください。</p>
    </div>

    <div style="margin-top:8px">
      <a class="btn ghost" href="{{ url_for('admin_entry') }}">← データ管理に戻る</a>
    </div>
  </div>
</body>
</html>
