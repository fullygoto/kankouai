<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>未ヒット質問一覧</title>
<style>
  body{font-family:'Segoe UI','メイリオ',sans-serif;background:#f6faf9;margin:0}
  .topbar{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid #e6edf3}
  .topbar .inner{max-width:980px;margin:0 auto;display:flex;justify-content:flex-end;gap:8px;padding:10px 14px}
  .container{max-width:980px;margin:20px auto 36px;background:#fff;border-radius:16px;box-shadow:0 4px 18px #b7d3e033;padding:26px}
  h1{margin:0 0 18px}
  .hint{color:#196;font-size:.95em;margin-bottom:14px}
  .card{border:1px solid #e6edf3;border-radius:12px;padding:14px 16px;margin:12px 0;background:#fbfefe}
  .q{font-weight:600;margin:2px 0 6px}
  .ts{color:#678;font-size:.92em;margin-bottom:8px}
  label{display:block;font-weight:600;margin:.4rem 0 .2rem}
  textarea,input[type=text]{width:100%;box-sizing:border-box;border:1px solid #bfd2e2;border-radius:8px;padding:8px 10px;font-size:14px}
  textarea{resize:vertical;min-height:84px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btns{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{border:none;border-radius:9px;padding:8px 14px;cursor:pointer;font:inherit}
  .primary{background:#2a8ed8;color:#fff}
  .ghost{background:#fff;border:1px solid #cfe1ef;color:#2a8ed8}
  .mini{font-size:.9em;padding:6px 10px}
  .tags-help{font-size:.9em;color:#678}
  .answer-preview{white-space:pre-wrap;background:#fff;border:1px dashed #d7e6f2;border-radius:8px;padding:8px 10px;margin-top:6px}
  .areas{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .areas label{font-weight:500}
  .empty{color:#999}
  a.btn{display:inline-block;text-decoration:none}
  @media (max-width:760px){.row{grid-template-columns:1fr}}
</style>
<script>
async function genFAQ(btn, idx){
  const wrap = document.getElementById('card-'+idx);
  const q = wrap.querySelector('input[name="__q"]').value;
  btn.disabled = true; const orig = btn.textContent; btn.textContent = '生成中...';
  try{
    const form = new FormData();
    form.append('q', q);
    const res = await fetch('{{ url_for("api_faq_suggest") }}', {method:'POST', body:form});
    const data = await res.json();
    if(!data.ok){ alert(data.error || '失敗しました'); }
    else{
      wrap.querySelector('textarea[name="desc"]').value = (data.text || '').trim();
    }
  }catch(e){ alert('通信に失敗しました'); }
  finally{ btn.disabled=false; btn.textContent=orig; }
}
function clip(str, n){ return (str || '').length>n ? str.slice(0,n) : (str||''); }
</script>
</head>
<body>

<!-- 右上の戻るボタン（常に表示） -->
<div class="topbar">
  <div class="inner">
    <a href="{{ url_for('admin_entry') }}" class="btn ghost mini">データ管理に戻る</a>
  </div>
</div>

<div class="container">
  <h1>未ヒット質問一覧（直近100件）</h1>
  <div class="hint">「編集して追加」相当の処理を <b>POST</b> に変更済み。長文でもURL制限にかかりません。</div>

  {% if unhit_logs and unhit_logs|length>0 %}
    {% for log in unhit_logs|reverse %}
      <div class="card" id="card-{{ loop.index0 }}">
        <div class="ts">{{ log.timestamp or '' }} / source: {{ log.source or 'web' }}</div>
        <div class="q">Q. {{ log.question }}</div>

        {% set initial_title = (log.question or '')[:40] %}
        {% set initial_desc  = (log.answer or '') %}
        <form method="post" action="{{ url_for('admin_add_entry') }}">
          <!-- 実際にDBへ入れる値 -->
          <label>タイトル（登録名）</label>
          <input type="text" name="title" value="{{ initial_title }}" required>

          <label>説明（FAQ文）</label>
          <textarea name="desc" placeholder="ここにFAQ文を入れます（AIで生成ボタンで自動入力可）">{{ initial_desc }}</textarea>

          <div class="row">
            <div>
              <label>タグ（カンマ区切り）</label>
              <input type="text" name="tags" placeholder="例: 教会, 五島うどん, 温泉">
              <div class="tags-help">※あとで一括編集も可</div>
            </div>
            <div>
              <label>エリア（カンマ区切り）</label>
              <input type="text" name="areas" value="">
              <div class="tags-help">例: 五島市, 新上五島町</div>
            </div>
          </div>

          <div class="btns">
            <button type="submit" class="btn primary">DBに追加</button>
            <button type="button" class="btn ghost mini" onclick="genFAQ(this, {{ loop.index0 }})">AIでFAQ案</button>
          </div>

          <!-- JS用の元質問（フォーム送信時はサーバー側で無視されます） -->
          <input type="hidden" name="__q" value="{{ log.question }}">
        </form>

        {% if log.answer %}
          <div class="answer-preview">
            <b>回答ログ（参考）</b><br>{{ log.answer }}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p class="empty">未ヒット質問はありません。</p>
  {% endif %}
</div>
</body>
</html>
