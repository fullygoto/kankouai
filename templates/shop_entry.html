<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>店舗情報管理</title>
  <style>
    body {font-family: 'Segoe UI','メイリオ',sans-serif; background:#f6faf9;}
    .container {background:#fff; padding:30px 32px; margin:40px auto; max-width:720px; border-radius:17px; box-shadow:0 4px 20px #b7d3e04d;}
    label {display:inline-block; min-width:70px; font-weight:500;}
    input[type=text], textarea, select {margin-bottom:12px; width:98%; padding:6px 10px; font-size:1em; border-radius:7px; border:1px solid #b0c4d7; background:#fff;}
    textarea {resize:vertical;}
    select, input[type=checkbox] {margin-bottom:10px;}
    .add-btn {padding:7px 24px; font-size:1em; border-radius:7px; background:#2a8ed8; color:#fff; border:none; margin-top:8px;}
    .extra-row {margin:6px 0;}
    .mini-note {font-size:0.92em; color:#888;}
    .thumb {max-width:240px; height:auto; border:1px solid #ccc; border-radius:4px;}
  </style>
  <script>
    function addExtraRowShop() {
      const wrap = document.getElementById('extras-list-shop');
      const div = document.createElement('div');
      div.className = 'extra-row';
      div.innerHTML = `
        <input name="extras_key[]" placeholder="キー">
        ＝
        <input name="extras_val[]" placeholder="値">
        <button type="button" onclick="this.parentNode.remove()">－</button>
      `;
      wrap.appendChild(div);
    }
    function validateAreasShop() {
      const checks = document.querySelectorAll('#shop_entry_form input[name="areas"]:checked');
      if (checks.length === 0) {
        alert('エリアは1つ以上選択してください。');
        return false;
      }
      return true;
    }
  </script>
</head>
<body>
<div class="container">
  <h1>店舗情報 登録・編集</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
      {% for message in messages %}
        <li style="color:green; font-weight:500;">{{ message }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <form method="post" id="shop_entry_form" enctype="multipart/form-data" onsubmit="return validateAreasShop()">
    <label>カテゴリー</label><br>

    {# 既存＋fullyGOTO をマージ（重複除去＆順序維持） #}
    {% set _base_cats = ["飲食","宿泊","診療所","役所","交通","バス","イベント","特売"] %}
    {% set _fg_cats = ["求人","五島を贈ろう","観光","泊まる","食べる・呑む","きれい","癒し","ショップ","生活","趣味・習い事"] %}
    {% set _ns = namespace(cats=_base_cats[:]) %}
    {% for c in _fg_cats %}{% if c not in _ns.cats %}{% set _ = _ns.cats.append(c) %}{% endif %}{% endfor %}
    {% set cat_list = _ns.cats %}

    <select name="category" id="category_select">
      {% for c in cat_list %}
        <option value="{{ c }}" {% if shop_edit and shop_edit.category == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select><br>

    <label>店舗名</label><br>
    <input type="text" name="title" value="{{ shop_edit.title if shop_edit else '' }}" required><br>

    <label>説明</label><br>
    <textarea name="desc" rows="3" required>{{ shop_edit.desc if shop_edit else '' }}</textarea><br>

    <!-- 画像アップロード -->
    <div class="mb-3">
      <label for="image_file_s" class="form-label">画像アップロード</label><br>
      <input type="file" id="image_file_s" name="image_file" accept="image/*">
      {% if shop_edit and (shop_edit.image_file or shop_edit.image) %}
        <div class="mt-2">
          <div>現在の画像:</div>
          <img
            class="thumb"
            src="{{ signed_image_url(shop_edit.image_file or shop_edit.image, wm=False) }}"
            alt="現在の画像"
            referrerpolicy="no-referrer"
            loading="lazy"
          />
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="image_delete_s" name="image_delete" value="1">
            <label class="form-check-label" for="image_delete_s">この画像を削除する</label>
          </div>
        </div>
      {% endif %}
      <small class="mini-note">
        JPEG/PNG/WebP（最大10MB）。アップロード時に自動リサイズされます（横1080px・約350KB）。
      </small>
    </div>

    <!-- 透かしON/OFF -->
    {% set _wm_on_edit = (shop_edit.wm_on if shop_edit and shop_edit.wm_on is not none else True) %}
    <div class="mt-2">
      <label style="display:inline-flex;align-items:center;gap:.4em;">
        <input type="checkbox" name="wm_on" value="1" {% if _wm_on_edit %}checked{% endif %}>
        外部公開URLに透かし（＠fullyGOTO）を付ける
      </label>
      <div class="mini-note">※一覧のサムネは常に透かし表示。ここは「クリック時の原寸URL」に適用されます。</div>
    </div>

    <!-- 緯度・経度（任意） -->
    <label>緯度・経度（任意）</label><br>
    <div class="row" style="display:flex; gap:10px; align-items:center;">
      <input type="text" name="lat" inputmode="decimal" pattern="-?\\d+(\\.\\d+)?"
             placeholder="緯度 例: 32.695"
             value="{{ shop_edit.lat if shop_edit and shop_edit.lat is not none else '' }}"
             style="width:48%;">
      <input type="text" name="lng" inputmode="decimal" pattern="-?\\d+(\\.\\d+)?"
             placeholder="経度 例: 128.845"
             value="{{ shop_edit.lng if shop_edit and shop_edit.lng is not none else '' }}"
             style="width:48%;">
    </div>
    <div class="mini-note">Googleマップで地点を長押し→座標をコピーして貼り付け。どちらか片方だけでは検索に使えません。</div>

    <label>住所</label><br>
    <input type="text" name="address" value="{{ shop_edit.address if shop_edit else '' }}"><br>

    <label>電話番号</label><br>
    <input type="text" name="tel" value="{{ shop_edit.tel if shop_edit else '' }}"><br>

    <label>休み</label><br>
    <input type="text" name="holiday" value="{{ shop_edit.holiday if shop_edit else '' }}"><br>

    <label>営業時間</label><br>
    <input type="text" name="open_hours" value="{{ shop_edit.open_hours if shop_edit else '' }}"><br>

    <label>駐車場</label>
    <select name="parking" style="width:auto;">
      <option value="あり" {% if shop_edit and shop_edit.parking == 'あり' %}selected{% endif %}>あり</option>
      <option value="なし" {% if shop_edit and shop_edit.parking == 'なし' %}selected{% endif %}>なし</option>
    </select>
    台数：<input type="text" name="parking_num" value="{{ shop_edit.parking_num if shop_edit else '' }}" style="width:80px;">台<br>

    <label>支払方法</label><br>
    {% set _pay = shop_edit.payment if shop_edit and shop_edit.payment is defined and shop_edit.payment is not string else (shop_edit.payment.split(',') if shop_edit and shop_edit.payment else []) %}
    <input type="checkbox" name="payment" value="現金"  {% if '現金'  in _pay %}checked{% endif %}>現金
    <input type="checkbox" name="payment" value="カード" {% if 'カード' in _pay %}checked{% endif %}>カード
    <input type="checkbox" name="payment" value="その他" {% if 'その他' in _pay %}checked{% endif %}>その他<br>

    <label>備考（自由記述）</label><br>
    <textarea name="remark" rows="2">{{ shop_edit.remark if shop_edit else '' }}</textarea><br>

    <label>タグ <span class="mini-note">（カンマ区切り）</span></label><br>
    <input type="text" name="tags" value="{% if shop_edit and shop_edit.tags %}{{ (shop_edit.tags|join(',')) if shop_edit.tags is not string else shop_edit.tags }}{% endif %}"><br>

    <label>エリア（市町）<span style="color:red; font-size:0.96em;">※1つ以上必須</span></label><br>
    {% set area_opts = ["五島市","新上五島町","宇久町","小値賀町"] %}
    <div class="row">
      {% set _areas = shop_edit.areas if shop_edit and shop_edit.areas is defined and shop_edit.areas is not string else (shop_edit.areas.split(',') if shop_edit and shop_edit.areas else []) %}
      {% for area in area_opts %}
        <label style="min-width:unset;">
          <input type="checkbox" name="areas" value="{{ area }}" {% if _areas and area in _areas %}checked{% endif %}>
          {{ area }}
        </label>
      {% endfor %}
    </div>

    <label>地図URL</label><br>
    <input type="text" name="map" value="{{ shop_edit.map if shop_edit else '' }}"><br>

    <!-- リンク（複数） -->
    <label>リンク（複数可）<span class="mini-note">（1行1URL／カンマ区切りも可）</span></label><br>
    <textarea name="links" rows="3" placeholder="https://example.com
https://instagram.com/xxx">{{ shop_edit.links|join('\n') if shop_edit and shop_edit.links else '' }}</textarea><br>

    <!-- 自由項目（キー＝値） -->
    <label>自由項目（キー＝値）</label>
    <div id="extras-list-shop">
      {% set _extras = (shop_edit.extras if shop_edit and shop_edit.extras else {}) %}
      {% if _extras.items is defined %}
        {% for k, v in _extras.items() %}
          <div class="extra-row">
            <input name="extras_key[]" value="{{ k }}" placeholder="例）問い合わせ窓口">
            ＝
            <input name="extras_val[]" value="{{ v }}" placeholder="例）info@example.com">
            <button type="button" onclick="this.parentNode.remove()">－</button>
          </div>
        {% endfor %}
      {% else %}
        <div class="extra-row">
          <input name="extras_key[]" placeholder="例）問い合わせ窓口">
          ＝
          <input name="extras_val[]" placeholder="例）info@example.com">
          <button type="button" onclick="this.parentNode.remove()">－</button>
        </div>
      {% endif %}
    </div>
    <button class="add-btn" type="button" style="background:#5aa;" onclick="addExtraRowShop()">＋ 行を追加</button>

    <button class="add-btn" type="submit">保存</button>
  </form>
</div>
</body>
</html>
