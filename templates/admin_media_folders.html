<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>画像フォルダを選択</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#f6faf9;--card:#fff;--line:#e7eef5;--brand:#2a8ed8;--muted:#567}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:var(--bg);padding:20px}
  .container{background:var(--card);max-width:1100px;margin:0 auto;padding:18px 20px;border-radius:14px;box-shadow:0 4px 18px #b7d3e033}
  h1{margin:0 0 10px}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .input{flex:1;min-width:220px;padding:8px 10px;border:1px solid #b7cfe2;border-radius:8px;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:10px}
  .card{border:1px solid #e5eef5;border-radius:10px;padding:12px;background:#fbfdff}
  .name{font-weight:600;color:#234;word-break:break-all}
  .muted{color:var(--muted);font-size:.92em}
  .btn{display:inline-block;padding:7px 12px;border-radius:8px;background:var(--brand);color:#fff;text-decoration:none}
  .btn.ghost{background:#fff;color:var(--brand);border:1px solid #b7d3e0}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  img{max-width:100%;height:150px;object-fit:cover;border:1px solid #e5eef5;border-radius:8px;background:#fff}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<div class="container">

  {% if folder %}
    <!-- ========= 画像一覧モード ========= -->
    <div class="topbar">
      <h1>フォルダ：{{ folder }}</h1>
      <div class="row">
        <a class="btn ghost" href="{{ url_for('admin_media_folders', entry_id=entry_id, next=next) }}">← フォルダ一覧</a>
        <a class="btn ghost" href="{{ next or url_for('admin_entry', edit=entry_id) }}">エントリに戻る</a>
        <a class="btn" href="{{ url_for('admin_watermark', picker=1, order='new', subdir=folder) }}" target="_blank" rel="noopener">ピッカーで開く</a>
      </div>
    </div>

    <div class="tools">
      <input id="q" class="input" type="search" placeholder="ファイル名で絞り込み（例: beach, 2024_ など）" autocomplete="off">
      <span class="muted"><span id="shown">0</span> / <span id="total">{{ images|length if images else 0 }}</span> 表示</span>
    </div>

    <div id="grid" class="grid">
      {% if images and images|length %}
        {% for f in images %}
          <div class="card" data-name="{{ f.name|lower }}">
            <a href="{{ f.url }}" target="_blank" rel="noopener">
              <img src="{{ f.url }}" loading="lazy" alt="{{ f.name }}">
            </a>
            <div class="name">{{ f.name }}</div>
            <div class="muted">更新: {{ f.ts }}</div>
            <div class="row" style="margin-top:6px">
              <!-- この画像を使う：編集中の観光データにアタッチ -->
              <form method="post" action="{{ url_for('admin_entry_attach') }}">
                <input type="hidden" name="entry_id" value="{{ entry_id }}">
                <input type="hidden" name="filename" value="{{ f.name }}">
                <input type="hidden" name="folder" value="{{ folder }}">
                <input type="hidden" name="next" value="{{ next or url_for('admin_entry', edit=entry_id) }}">
                <button class="btn" type="submit">この画像を使う</button>
              </form>
              <!-- 透かし単体編集 -->
              <a class="btn ghost" href="{{ url_for('admin_watermark_one', src=(folder ~ '/' ~ f.name)) }}" target="_blank" rel="noopener">再生成/編集</a>
              <!-- 削除（元＋派生まとめて） -->
              <form method="post" action="{{ url_for('admin_media_delete') }}" onsubmit="return confirm('この画像（元＋派生）を削除します。よろしいですか？');">
                <input type="hidden" name="filename" value="{{ folder ~ '/' ~ f.name }}">
                <button class="btn ghost" type="submit">削除</button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted">画像が見つかりません。</div>
      {% endif %}
    </div>

  {% else %}
    <!-- ========= フォルダ一覧モード ========= -->
    <div class="topbar">
      <h1>画像フォルダを選択</h1>
      <div class="row">
        <a class="btn ghost" href="{{ url_for('admin_entry') }}">データ管理に戻る</a>
        <a class="btn" href="{{ url_for('admin_watermark', picker=1, order='new') }}" target="_blank" rel="noopener">全体から選ぶ（ピッカー）</a>
      </div>
    </div>

    <div class="tools">
      <input id="q" class="input" type="search" placeholder="フォルダ名で絞り込み（例: 2024, summer, beach）" autocomplete="off">
      <span class="muted"><span id="shown">0</span> / <span id="total">{{ folders|length if folders else 0 }}</span> 表示</span>
    </div>

    <div id="grid" class="grid">
      {% if folders and folders|length %}
        {% for f in folders %}
          <div class="card" data-name="{{ f|lower }}">
            <div class="name">{{ f }}</div>
            <div class="muted">{{ (folder_counts[f] ~ ' 枚（元画像）') if folder_counts is defined and f in folder_counts else '' }}</div>
            <div class="row" style="margin-top:8px">
              <!-- 同ページで画像一覧モードへ遷移（entry_id/next を引き継ぐ） -->
              <a class="btn" href="{{ url_for('admin_media_folders', folder=f, entry_id=entry_id, next=next) }}">
                このフォルダの画像を表示
              </a>
              <!-- ピッカー直行（従来UIが良ければこちら） -->
              <a class="btn ghost" href="{{ url_for('admin_watermark', picker=1, order='new', subdir=f) }}" target="_blank" rel="noopener">
                ピッカーで開く
              </a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted">フォルダがありません。</div>
      {% endif %}
    </div>
  {% endif %}

</div>

<script>
(function(){
  const q = document.getElementById('q');
  const grid = document.getElementById('grid');
  const shown = document.getElementById('shown');
  function update(){
    if(!q || !grid) return;
    const term = (q.value||'').trim().toLowerCase();
    let c=0;
    grid.querySelectorAll('.card').forEach(card=>{
      const ok = !term || (card.dataset.name||'').includes(term);
      card.style.display = ok ? '' : 'none';
      if(ok) c++;
    });
    if(shown) shown.textContent = c;
  }
  if(q) q.addEventListener('input', update);
  update();
})();
</script>
</body>
</html>
