<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>画像を選択</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --bg:#f6faf9; --card:#fff; --muted:#567; --line:#e7eef5; --brand:#2a8ed8; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP','Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:var(--bg);margin:0;padding:18px}
    .wrap{max-width:1100px;margin:0 auto;background:#fff;border-radius:14px;box-shadow:0 4px 18px #b7d3e033;padding:16px}
    h1{margin:0 0 10px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .muted{color:var(--muted);font-size:.92em}
    .input{width:320px;max-width:60vw;padding:8px 10px;border:1px solid #b7cfe2;border-radius:8px}
    .btn{display:inline-block;padding:8px 12px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer;text-decoration:none}
    .btn.ghost{background:#fff;color:var(--brand);border:1px solid #b7d3e0}
    .btn.small{padding:6px 10px;font-size:.92em}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:12px}
    .card{border:1px solid var(--line);border-radius:12px;background:#fbfdff;padding:10px;display:flex;flex-direction:column}
    .fname{font-size:.92em;color:#234;word-break:break-all}
    .thumbbox{position:relative;border:1px solid #e5eef5;border-radius:10px;background:#fff;height:150px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin:8px 0}
    .thumb{max-width:100%;max-height:100%;display:block}
    .placeholder{font-size:.9em;color:#789}
    .meta{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .counts{font-size:.92em;color:var(--muted)}
    .crumb{color:#567;font-size:.92em;margin-bottom:6px}
    .toplinks{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>画像を選択</h1>
    {% if folder %}
      <div class="crumb">フォルダ: <strong>{{ folder }}</strong></div>
    {% endif %}

    <div class="bar">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input id="q" class="input" type="search" placeholder="名前で絞り込み（例: 2024, summer, beach, xxx.jpg）" autocomplete="off">
        <span class="counts"><span id="shown">0</span> / <span id="total">0</span> 表示</span>
      </div>
      <div class="toplinks">
        <a class="btn ghost" href="{{ url_for('admin_entry') }}">データ管理に戻る</a>
        <a class="btn ghost" href="{{ url_for('admin_watermark', picker=1, order='new') }}">全体から選ぶ（ピッカー）</a>
      </div>
    </div>

    <div id="grid" class="grid">
      {% for it in images %}
        {# --- it は dict/obj/文字列 いずれでも動くように頑丈に取得 --- #}
        {% set name = (it.name if it is mapping or it is not string and it.name is defined else (it['name'] if it['name'] is defined else (it|string))) %}
        {% set rel  = (it.rel  if it is mapping and it.rel  is defined else (it['rel']  if it['rel']  is defined else name)) %}
        {% set ts   = (it.ts   if it is mapping and it.ts   is defined else (it['ts']   if it['ts']   is defined else '')) %}
        {% set v    = (it.v    if it is mapping and it.v    is defined else (it['v']    if it['v']    is defined else '')) %}

        {# サイン付きで確実に出るサムネ（wm=1=thumb）。ts/v があればキャッシュ避け用に付加 #}
        {% set thumb = safe_url_for('serve_image', filename=name, _sign=True, wm=1) ~ (('&_ts=' ~ v)|string if v else '') %}
        {% set view  = safe_url_for('serve_image', filename=name, _sign=True) %}
        {% set more  = url_for('admin_watermark_one', src=name) if has_endpoint('admin_watermark_one') else url_for('admin_watermark', picker=1, order='new') %}

        <div class="card" data-name="{{ name|lower }}">
          <div class="meta">
            <span class="fname">{{ name }}</span>
            {% if ts %}<span class="muted">{{ ts }}</span>{% endif %}
          </div>

          <a class="thumbbox" href="{{ view }}" target="_blank" rel="noopener">
            <img class="thumb" src="{{ thumb }}" loading="lazy" referrerpolicy="no-referrer" alt="{{ name }}"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;placeholder&quot;>プレビューなし</div>';">
          </a>

          <div class="actions">
            <button class="btn small" data-pick="{{ name }}">この画像を選ぶ</button>
            <a class="btn ghost small" href="{{ more }}" target="_blank" rel="noopener">詳細/透かし</a>
          </div>
        </div>
      {% endfor %}
      {% if not images or images|length == 0 %}
        <div class="muted">画像が見つかりません。</div>
      {% endif %}
    </div>
  </div>

  <script>
    (function(){
      const grid = document.getElementById('grid');
      const q    = document.getElementById('q');
      const shown= document.getElementById('shown');
      const total= document.getElementById('total');

      function cards(){ return Array.from(grid.querySelectorAll('.card')); }
      function updateCounts(){
        total.textContent = cards().length;
        shown.textContent = cards().filter(c => c.style.display !== 'none').length;
      }
      function filter(){
        const t = (q.value||'').trim().toLowerCase();
        cards().forEach(c=>{
          const name = c.dataset.name || '';
          c.style.display = (!t || name.includes(t)) ? '' : 'none';
        });
        updateCounts();
      }
      q.addEventListener('input', filter);
      updateCounts();

      // ✅ ピッカー（親へ返すURLはプレースホルダ置換で正しく生成）
      grid.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-pick]');
        if(!btn) return;
        const name = btn.getAttribute('data-pick');

        // 署名付き serve_image のテンプレ（__NAME__ を置換）
        const tmpl = "{{ safe_url_for('serve_image', filename='__NAME__', _sign=True) }}";
        const url  = tmpl.replace('__NAME__', encodeURIComponent(name));

        try{
          window.opener && window.opener.postMessage({ type:'media-pick', files:[name], urls:[url] }, location.origin);
        }catch(_){}
        // ピッカー用途なら閉じる（通常は閉じない）
        if(new URLSearchParams(location.search).get('picker') === '1'){
          window.close();
        }
      });

      // 初期フィルタ（空でカウント反映）
      filter();
    })();
  </script>
</body>
</html>
