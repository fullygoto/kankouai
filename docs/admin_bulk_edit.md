# 観光データ一括編集ガイド

管理画面の「観光データ一括編集」機能でデータを安全に更新するための仕様と運用上の注意点をまとめます。フォームで入力した値は `entries.json` のスキーマに合わせて検証され、正しい差分のみが反映されます。

## 対象フィールドとスキーマ対応

| UI項目 | `entries.json` のキー | 型 | 必須 | 備考 |
| ------ | -------------------- | --- | ---- | ---- |
| カテゴリー | `category` | 文字列 | 既定値あり | 未入力時は `観光` が設定されます |
| タイトル | `title` | 文字列 | 必須 | 空欄の場合は保存できません |
| 説明 | `desc` | 文字列 | 必須 (空文字可) | 全角空白のみの場合は空として扱われます |
| 住所 | `address` | 文字列 | 任意 | |
| 地図URL | `map` | 文字列 | 任意 | |
| タグ | `tags` | 文字列配列 | 任意 | カンマ/改行で区切って入力します |
| エリア | `areas` | 文字列配列 | 必須 | 1件以上の値が必要です |
| 電話 | `tel` | 文字列 | 任意 | |
| 定休日 | `holiday` | 文字列 | 任意 | |
| 営業時間 | `open_hours` | 文字列 | 任意 | |
| 駐車 | `parking` | 文字列 | 任意 | プルダウンから選択 |
| 台数 | `parking_num` | 文字列 | 任意 | |
| 支払方法 | `payment` | 文字列配列 | 任意 | カンマ/改行区切り |
| 備考 | `remark` | 文字列 | 任意 | |
| 参考リンク (hidden) | `links` | 文字列配列 | 任意 | 既存のリンクは hidden フィールドで保持されます |

上記以外の未知フィールドが送信された場合は、入力エラーとして 422 応答になります。フォームを改変する際は、この一覧に項目を追記してください。

## 差分更新と削除

* フォームに表示されていない既存レコードは、自動的に保持されます。編集対象のみ送信した場合でも他のデータは削除されません。
* 「削除」ボタンを押すと対象行の ID が `deleted_row_ids[]` として送信され、その行だけが削除されます。
* 送信された `row_id` が重複している、または削除指定と衝突している場合はエラーになり、保存処理は実行されません。
* すべての変更は `_validate_entries_payload` で検証され、必須項目が欠けている場合や 0 件保存が禁止されている場合は保存されません。

## ログと監査

UI からの保存時には次の情報がアプリケーションログに出力されます。

```
[admin_entries_edit] ui bulk edit: requested_rows=… updates=… creates=… deletes=… final_total=…
```

ログから更新件数・追加件数・削除件数を把握できます。異常が疑われる場合は直近のバックアップ (`backups/entries-backup-*.json`) を利用して復元してください。

## 運用上のヒント

* フォームの送信前に最低1件の行で「タイトル」「エリア」が埋まっていることを確認してください。全行が空の場合は確認ダイアログ後に空配列での保存が実行されます。
* CSV 取り込みや他ツールとの連携でフィールドを追加したい場合は、アプリケーション側にフィールドの追加を実装してからフォームに反映します。
* 大量件数（1,000件程度）でもテスト済みですが、保存前にブラウザの入力内容をエクスポートしておくと安心です。
