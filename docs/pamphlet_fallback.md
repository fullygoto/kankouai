# パンフレット検索フォールバック運用メモ

## データ配置

- パンフレットテキストは UTF-8 で保存し、以下の階層に配置します。

```
{PAMPHLET_BASE_DIR}/
  goto/         # 五島市
  shinkamigoto/ # 新上五島町
  ojika/        # 小値賀町
  uku/          # 宇久町
```

- ファイル名は任意ですが、回答末尾の「出典」に表示されるため判別しやすい名前にしてください。
- 1ファイル=1パンフレットの想定です。長文は自動で 1,500 文字前後に分割されます。

## 環境変数の確認

| 変数名 | 役割 | 備考 |
| ------ | ---- | ---- |
| `PAMPHLET_BASE_DIR` | パンフレットの保存先ルート | 既定 `/var/data/pamphlets` |
| `PAMPHLET_TOPK` | 要約に渡すチャンク数 | 既定 3 件 |
| `PAMPHLET_CHUNK_SIZE` | チャンクサイズ（文字数） | 既定 1500 |
| `PAMPHLET_CHUNK_OVERLAP` | チャンク重複（文字数） | 既定 200 |
| `PAMPHLET_SESSION_TTL` | 市町選択の保持秒数 | 既定 1800（30分） |

## インデックス再構築

1. パンフレットを追加・更新したら `/admin/pamphlet-reindex` にアクセス（GET）します。
2. レスポンス例：
   ```json
   {
     "status": "ok",
     "result": {
       "goto": {"state": "ready"},
       "shinkamigoto": {"state": "empty"},
       ...
     },
     "pamphlet_index": "ready"
   }
   ```
3. `/readyz` でも `pamphlet_index` の状態を確認できます。各市町ごとの詳細は `pamphlet_index_status` フィールドに格納されており、`status` が `degraded` の場合は `errors` に原因が並びます。

## LINE 応答フロー

1. 固定応答（天気・運行状況・マップ）や観光スポットDBで回答できない場合にフォールバックが起動します。
2. ユーザーから市町が特定できない質問を受けると、次のクイックリプライを一度だけ提示します。
   - 「五島市」「新上五島町」「小値賀町」「宇久町」
3. 市町が決まると、該当フォルダのパンフレットを検索して上位3件を GPT-5-nano で要約します。回答末尾には `出典（ファイル名）` が必ず付与されます。
4. 追加情報が必要な場合はユーザーが「もっと詳しく」と送信すると詳細要約を再提示します（同一質問内で30分間有効）。

## トラブルシューティング

- **資料がヒットしない**: ファイル名やフォルダ階層が正しいか確認し、`/admin/pamphlet-reindex` を再実行してください。
- **要約が表示されない**: OpenAI API キー設定を確認し、`OPENAI_API_KEY` が有効かチェックしてください。キー未設定でも上位テキストの抜粋が返るようフェイルセーフになっています。
- **LINEで市町選択が繰り返し表示される**: ユーザーに市町を選択するよう案内してください。システム側では1回のみクイックリプライを表示し、その後はテキストで促す仕様です。
